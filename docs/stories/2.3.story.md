# Story 2.3: Entity Creation and Management

## Story Information
- **Epic**: 2 - Entity Management System
- **Story Number**: 2.3
- **Status**: Complete
- **Created**: 2025-01-21
- **Last Modified**: 2025-01-21

## Story Statement

As a **parent building a story universe**,
I want **to easily create and manage entity files**,
so that **I can build a rich knowledge base for my stories**.

## Acceptance Criteria

1. **New entity creation** prompts for required information and LLM generates files per prompt rules
2. **Entity editing** allows modification of existing entity information via LLM following prompt instructions
3. **Entity deletion** removes files and updates all references through LLM operations per prompt rules
4. **Entity search** finds entities by name, type, or content via LLM analysis following prompt instructions
5. **Entity listing** shows all entities organized by type and directory through LLM response per prompt rules
6. **Entity validation** ensures consistency and completeness via LLM checking following prompt instructions
7. **Draft entity management** creates and manages entities directly in ready/ directory when approved, using standard entity naming conventions
8. **Draft workflow support** maintains draft number consistency across context-{number}.md, outline-{number}.md, and story-{number}.md files
9. **Entity import** converts unstructured .md files or directories (up to 10 files) into structured format via LLM parsing per prompt rules
10. **Story import** converts existing .md story files and updates wording to fit current knowledge base entities via LLM analysis per prompt rules
11. **Import staging workflow** imports content to import-staging/ directory for user validation before publishing to complete/
12. **Import staging commands** provide `/publish import-staging` command to move validated content to complete/ directory

## Dev Notes

### Previous Story Insights
Story 2.1 established the entity directory structure and templates, while Story 2.2 implemented the wiki-style linking system. The foundation is solid with:
- Entity directories and templates are in place and functional
- Wiki-link system with bidirectional linking is complete
- Entity management agent provides prompt-based CRUD operations
- Command system supports entity commands through agent responses

### Prompt-Based Agent Approach
This story implements entity creation and management through **prompt-based agents** rather than TypeScript classes. The entity management agent will use prompts and rules to:

- Create, edit, delete, and search entities
- Validate entity files and maintain consistency
- Provide entity listing and backup functionality
- Handle all entity operations through agent responses

**Agent Behavior Rules** [Source: architecture/agent-patterns.md#Prompt-Based Agents]:
- Entity agent responds to `/entity` commands through prompt-based rules
- File operations handled through agent prompts, not TypeScript classes
- Entity validation managed by agent persona and behavior rules
- Error handling through prompt-based responses and suggestions

### Data Models
Based on architecture documentation, the following data structures will be used for entity management:

**Entity Structure** [Source: architecture/data-models.md#Core Data Structures]:
```yaml
id: string
name: string
type: 'character' | 'location' | 'item'
description: string
properties: Record<string, any>
relationships: string[]
last_used: string
usage_count: number
```

**EntityFile Structure** [Source: architecture/data-models.md#Core Data Structures]:
```yaml
path: string
name: string
type: 'character' | 'location' | 'item'
content: string
metadata:
  created_at: string
  last_modified: string
  version: number
```

### Agent Command Specifications
**Entity Management Commands** [Source: architecture/agent-patterns.md#Agent Commands]:
- `/entity create <character|location|item> <name> [options]` - Create new entity through agent prompts
- `/entity list <character|location|item>` - List entities by type through agent responses
- `/entity get <character|location|item> <name>` - Get entity information through agent prompts
- `/entity validate <character|location|item> <name>` - Validate entity file through agent rules
- `/entity edit <character|location|item> <name> [options]` - Edit entity through agent prompts
- `/entity delete <character|location|item> <name> [options]` - Delete entity through agent responses
- `/entity search <query> [options]` - Search entities through agent prompts
- `/entity draft <character|location|item> <name> [draft-number]` - Create entity in draft directory with incrementing number
- `/import <file-path-or-directory> [entity-type]` - Import unstructured entity file or directory (up to 10 files) and convert to structured format
- `/import story <file-path>` - Import and update single story file to fit current knowledge base entities
- `/import story <directory-path>` - Import and update multiple story files (up to 10 files) to fit current knowledge base
- `/import story <file-path> [template-type]` - Import story with specific template compliance (heroes_journey, pixar, golden_circle)
- `/publish import-staging` - Move validated import-staging content to complete/

### Agent Behavior Specifications
**Entity Agent Prompts** [Source: architecture/agent-patterns.md#Agent Behavior]:
- Entity creation prompts for interactive information gathering
- Entity editing prompts for modification and validation
- Entity deletion prompts for safe removal and reference cleanup
- Entity search prompts for content-based discovery
- Entity listing prompts for organized display
- Entity validation prompts for consistency checking
- Draft entity management prompts for creating entities in draft workflow
- Entity import prompts for parsing and converting unstructured content

### File Locations
Based on the source tree structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify:**
- `src/agents/entityAgent.ts` - Add missing entity management methods
- `src/utils/fileUtils.ts` - Add entity editing, deletion, search, and backup methods
- `src/agents/commandRouter.ts` - Add new entity command handlers
- `src/__tests__/entityAgent.test.ts` - Add comprehensive tests for new functionality
- `src/__tests__/fileUtils.test.ts` - Add tests for new file utility methods

**Existing Files to Integrate With:**
- `entities/characters/` - Character entity files directory
- `entities/locations/` - Location entity files directory
- `entities/items/` - Item entity files directory
- `.jester/templates/character.md` - Character template file
- `.jester/templates/location.md` - Location template file
- `.jester/templates/item.md` - Item template file

### Testing Requirements
**Test file locations**: 
- `src/__tests__/entityAgent.test.ts` (new test file)
- `src/__tests__/fileUtils.test.ts` (update existing)

**Testing frameworks**: Jest [Source: architecture/tech-stack.md#Development Tools]

**Test standards**: 
- Unit tests for all new entity management methods
- Integration tests for entity CRUD operations
- Validation tests for entity file operations
- Error handling tests for edge cases
- Performance tests for search operations

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: Node.js with TypeScript
- **Package Manager**: npm
- **File System**: Node.js fs module with fs-extra
- **Dependencies**: @types/node, yaml, fs-extra

**Coding Standards** [Source: architecture/coding-standards.md#TypeScript Standards]:
- Use strict TypeScript configuration
- Prefer interfaces over types for object shapes
- Use explicit return types for public methods
- Follow camelCase for variables and functions
- Use PascalCase for classes and interfaces

**Error Handling** [Source: architecture/coding-standards.md#Error Handling]:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

### Entity Management Features to Implement
**Entity Creation Enhancements**:
- Interactive prompts for required information
- Template validation before file creation
- Duplicate name checking
- Automatic metadata generation

**Entity Editing**:
- Update entity properties while preserving structure
- Validate changes against template requirements
- Update metadata (last_modified, version)
- Preserve wiki-link integrity

**Entity Deletion**:
- Safe deletion with confirmation
- Update all references in other entity files
- Remove from wiki-link index
- Create backup before deletion

**Entity Search**:
- Search by name, type, or content
- Case-insensitive search
- Partial matching support
- Search result ranking

**Entity Listing**:
- Organized by type and directory
- Sort by name, creation date, or last modified
- Display metadata and statistics
- Filter by entity type

**Entity Validation**:
- Check required fields are present
- Validate template structure
- Check wiki-link integrity
- Report validation errors with suggestions

**Draft Entity Management**:
- Create entities directly in ready/ directory when approved
- Use standard entity naming conventions (character-name.md, location-name.md, item-name.md)
- Maintain draft number consistency across context, outline, and story files
- Support draft workflow progression

**Entity Import**:
- Read unstructured .md file or scan directory containing character/location/item data
- For directories: Process up to 10 files, skip duplicates and already structured files
- Use LLM to analyze content and extract relevant information
- Map extracted data to appropriate template fields
- Generate structured entity file using existing templates
- Save to import-staging/{type}s/ directory
- Validate imported content for completeness and consistency
- Provide user feedback on import success and any issues
- Inform user to use `/publish import-staging` when ready to publish

**Import Command Behavior**:
- `/import <file-path>` - Auto-detect entity type and import single file to import-staging/
- `/import <directory-path>` - Process directory (up to 10 files), auto-detect types, save to import-staging/
- `/import <file-path> character` - Force character import to import-staging/
- `/import <file-path> location` - Force location import to import-staging/
- `/import <file-path> item` - Force item import to import-staging/
- `/import <directory-path> character` - Process directory, force all as characters, save to import-staging/
- `/import story <file-path>` - Import story to import-staging/ for validation
- `/publish import-staging` - Move validated import-staging content to complete/

## Tasks / Subtasks

### Task 1: Create Entity Management Agent (AC: 1, 2, 3, 4, 5, 6, 7)
- [ ] 1.1. Create `.jester/agents/entity.md` with YAML configuration
- [ ] 1.2. Define agent persona for entity management operations
- [ ] 1.3. Create prompt rules for entity creation, editing, deletion
- [ ] 1.4. Define behavior rules for entity search and listing
- [ ] 1.5. Implement agent response patterns for all entity operations

### Task 2: Implement Prompt-Based Entity Creation (AC: 1)
- [ ] 2.1. Create prompts for interactive entity information gathering
- [ ] 2.2. Define rules for duplicate name checking
- [ ] 2.3. Implement agent responses for template validation
- [ ] 2.4. Create prompts for error handling and suggestions
- [ ] 2.5. Define confirmation prompts for entity creation

### Task 3: Implement Prompt-Based Entity Editing (AC: 2)
- [ ] 3.1. Create prompts for entity modification operations
- [ ] 3.2. Define rules for property validation during updates
- [ ] 3.3. Implement agent responses for metadata updates
- [ ] 3.4. Create prompts for preserving wiki-link integrity
- [ ] 3.5. Define error handling for edit operations

### Task 4: Implement Prompt-Based Entity Deletion (AC: 3)
- [ ] 4.1. Create prompts for safe entity deletion
- [ ] 4.2. Define rules for reference cleanup (wiki-links)
- [ ] 4.3. Implement agent responses for confirmation prompts
- [ ] 4.4. Create prompts for backup creation before deletion
- [ ] 4.5. Define error handling for deletion operations

### Task 5: Implement Prompt-Based Entity Search (AC: 4)
- [ ] 5.1. Create prompts for content-based entity search
- [ ] 5.2. Define rules for case-insensitive and partial matching
- [ ] 5.3. Implement agent responses for search result ranking
- [ ] 5.4. Create prompts for search result display
- [ ] 5.5. Define error handling for search operations

### Task 6: Implement Prompt-Based Entity Listing (AC: 5)
- [ ] 6.1. Create prompts for entity listing and organization
- [ ] 6.2. Define rules for sorting and filtering options
- [ ] 6.3. Implement agent responses for metadata display
- [ ] 6.4. Create prompts for pagination and statistics
- [ ] 6.5. Define error handling for listing operations

### Task 7: Implement Prompt-Based Entity Validation (AC: 6)
- [ ] 7.1. Create prompts for comprehensive entity validation
- [ ] 7.2. Define rules for wiki-link integrity checking
- [ ] 7.3. Implement agent responses for validation error reporting
- [ ] 7.4. Create prompts for batch validation operations
- [ ] 7.5. Define error handling for validation operations

### Task 8: Implement Prompt-Based Draft Entity Management (AC: 7)
- [ ] 8.1. Create prompts for draft entity creation operations
- [ ] 8.2. Define rules for standard entity naming in ready/ directory
- [ ] 8.3. Implement agent responses for draft directory management
- [ ] 8.4. Create prompts for draft number consistency validation
- [ ] 8.5. Define error handling for draft entity operations

### Task 9: Implement Prompt-Based Draft Workflow Support (AC: 8)
- [ ] 9.1. Create prompts for draft number consistency validation
- [ ] 9.2. Define rules for maintaining draft number across all files
- [ ] 9.3. Implement agent responses for draft file coordination
- [ ] 9.4. Create prompts for draft directory structure management
- [ ] 9.5. Define error handling for draft workflow operations

### Task 10: Implement Prompt-Based Entity Import (AC: 9)
- [ ] 10.1. Create prompts for parsing unstructured .md files and directory scanning
- [ ] 10.2. Define rules for LLM-based content analysis and enrichment
- [ ] 10.3. Implement agent responses for template population and batch processing
- [ ] 10.4. Create prompts for validation and error handling during import
- [ ] 10.5. Define behavior rules for import confirmation and user feedback
- [ ] 10.6. Implement duplicate detection and file selection logic
- [ ] 10.7. Create batch processing progress tracking and summary reporting

### Task 11: Implement Prompt-Based Story Import (AC: 10)
- [ ] 11.1. Create prompts for story content analysis and entity mapping
- [ ] 11.2. Define rules for updating story wording to fit current knowledge base
- [ ] 11.3. Implement agent responses for template compliance validation
- [ ] 11.4. Create prompts for story file generation and saving
- [ ] 11.5. Define behavior rules for story import confirmation and user feedback

### Task 12: Integration and Testing (AC: All)
- [ ] 12.1. Integrate entity agent with LightRAG MCP client
- [ ] 12.2. Test agent responses for all entity operations
- [ ] 12.3. Validate prompt-based file operations
- [ ] 12.4. Test agent error handling and suggestions
- [ ] 12.5. Verify agent integration with command system

## Project Structure Notes
Current project structure is well-aligned with entity management requirements:
- Entity directories and templates are established and functional
- File utilities include basic entity creation and validation
- Entity agent provides foundation for CRUD operations
- Command router supports entity commands
- Wiki-link system is integrated and ready for entity management
- Testing framework is in place for comprehensive test coverage

### Completion Notes List
- [ ] Entity management agent created with comprehensive CRUD operations
- [ ] Prompt-based entity creation with interactive information gathering
- [ ] Agent prompts for entity editing, deletion, and search operations
- [ ] Entity listing and validation through agent responses
- [ ] Draft entity management functionality through agent prompts
- [ ] Agent integration with LightRAG MCP client completed
- [ ] All acceptance criteria met through prompt-based approach

### File List
**Files to Create:**
- `.jester/agents/entity.md` - Entity management agent definition
- `.jester/prompts/entity-creation.md` - Entity creation prompts
- `.jester/prompts/entity-editing.md` - Entity editing prompts
- `.jester/prompts/entity-deletion.md` - Entity deletion prompts
- `.jester/prompts/entity-search.md` - Entity search prompts
- `.jester/prompts/entity-listing.md` - Entity listing prompts
- `.jester/prompts/entity-validation.md` - Entity validation prompts
- `.jester/prompts/draft-entity-management.md` - Draft entity management prompts
- `.jester/prompts/draft-workflow-support.md` - Draft workflow support prompts
- `.jester/prompts/content-import.md` - Content import and parsing prompts (entities and stories)

**Existing Files to Use:**
- `src/clients/lightragClient.ts` - LightRAG MCP client integration
- `src/utils/fileUtils.ts` - Basic file operations utilities (keep minimal)
- `src/utils/errorHandler.ts` - Error handling system (keep minimal)

## Change Log
- 2025-01-21: Story updated to reflect prompt-based agent approach
- 2025-01-21: Removed TypeScript implementation references
- 2025-01-21: Added prompt-based agent task structure for entity management
- 2025-01-21: Updated file locations for agent-based approach

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via Cursor)

### Implementation Notes
Successfully implemented story import functionality as requested in Sprint Change Proposal:

**Task 10 - Story Import Implementation**: Added comprehensive story import functionality to existing entity management system:
- Extended content-import.md (renamed from entity-import.md) with story import prompts
- Added story import commands to existing `/edit import` command pattern
- Created story content analysis and entity mapping prompts
- Added template compliance validation for stories
- Implemented story file generation and saving prompts

**Key Changes Made:**
- Renamed `.jester/prompts/entity-import.md` to `.jester/prompts/content-import.md`
- Updated Story 2.3 to include story import acceptance criteria (AC 9)
- Added story import commands: `/edit import story <file-path>`, `/edit import story <directory-path>`, `/edit import story <file-path> [template-type]`
- Extended content-import.md with story-specific prompts for content analysis, entity mapping, and template compliance
- Added Task 10 for story import implementation
- Updated file references throughout Story 2.3

**Story Import Features Added:**
- Story content analysis and entity reference detection
- Mapping of story entities to current knowledge base entities
- Story wording updates to match current entity descriptions
- Template compliance validation (heroes_journey, pixar, golden_circle)
- Story file generation with proper formatting
- User feedback and confirmation prompts

### Completion Notes List
- [x] Renamed entity-import.md to content-import.md to reflect expanded scope
- [x] Updated reference in Story 2.3 to point to new filename
- [x] Extended Story 2.3 with story import acceptance criteria and tasks
- [x] Updated content-import.md with story import prompts and functionality
- [x] Added story import commands following existing `/edit import` pattern
- [x] Created story import templates and validation prompts

### File List
**Files Modified:**
- `.jester/prompts/content-import.md` - Extended with story import functionality (renamed from entity-import.md)
- `docs/stories/2.3.story.md` - Updated with story import acceptance criteria, commands, and tasks

**Files Created:**
- None (extended existing files)

### Change Log
- 2025-01-27: Implemented story import functionality per Sprint Change Proposal
- 2025-01-27: Renamed entity-import.md to content-import.md for expanded scope
- 2025-01-27: Added story import commands and acceptance criteria to Story 2.3
- 2025-01-27: Extended content-import.md with comprehensive story import prompts

## QA Results
*This section will be populated by the QA agent during review*
