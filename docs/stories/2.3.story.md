# Story 2.3: Entity Creation and Management

## Story Information
- **Epic**: 2 - Entity Management System
- **Story Number**: 2.3
- **Status**: Draft
- **Created**: 2025-01-21
- **Last Modified**: 2025-01-21

## Story Statement

As a **parent building a story universe**,
I want **to easily create and manage entity files**,
so that **I can build a rich knowledge base for my stories**.

## Acceptance Criteria

1. **New entity creation** prompts for required information and generates files
2. **Entity editing** allows modification of existing entity information
3. **Entity deletion** removes files and updates all references
4. **Entity search** finds entities by name, type, or content
5. **Entity listing** shows all entities organized by type and directory
6. **Entity validation** ensures consistency and completeness
7. **Entity backup** creates copies before major changes

## Dev Notes

### Previous Story Insights
Story 2.1 established the entity directory structure and templates, while Story 2.2 implemented the wiki-style linking system. The foundation is solid with:
- Entity directories and templates are in place and functional
- Wiki-link system with bidirectional linking is complete
- File utilities include entity creation and validation methods
- Command router supports entity commands (create, list, get, validate)
- Entity agent provides basic CRUD operations

### Data Models
Based on architecture documentation, the following data structures will be used for entity management:

**Entity Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface Entity {
  id: string;
  name: string;
  type: 'character' | 'location' | 'item';
  description: string;
  properties: Record<string, any>;
  relationships: string[];
  last_used: string;
  usage_count: number;
}
```

**EntityFile Interface** [Source: src/types/index.ts]:
```typescript
interface EntityFile {
  path: string;
  name: string;
  type: 'character' | 'location' | 'item';
  content: string;
  metadata: {
    created_at: string;
    last_modified: string;
    version: number;
  };
}
```

**Character Interface** [Source: src/types/index.ts]:
```typescript
interface Character {
  name: string;
  type: string;
  age: string;
  species: string;
  description: string;
  personality_traits: string[];
  motivations: string[];
  fears: string[];
  family_relationships: string[];
  friend_relationships: string[];
  enemy_relationships: string[];
  first_story: string;
  recent_story: string;
  story_count: number;
  physical_description: string;
  clothing_style: string;
  distinctive_features: string[];
  special_powers: string[];
  skills: string[];
  weaknesses: string[];
  backstory: string;
  additional_notes: string;
  metadata: {
    created_at: string;
    last_modified: string;
    version: number;
  };
}
```

### API Specifications
**Entity Management Commands** [Source: src/agents/commandRouter.ts#Entity Commands]:
- `/entity create <character|location|item> <name> [options]` - Create new entity
- `/entity list <character|location|item>` - List entities by type
- `/entity get <character|location|item> <name>` - Get entity information
- `/entity validate <character|location|item> <name>` - Validate entity file
- `/entity edit <character|location|item> <name> [options]` - Edit entity (to be implemented)
- `/entity delete <character|location|item> <name> [options]` - Delete entity (to be implemented)
- `/entity search <query> [options]` - Search entities (to be implemented)
- `/entity backup <character|location|item> <name>` - Backup entity (to be implemented)

### Component Specifications
**EntityAgent Class** [Source: src/agents/entityAgent.ts]:
- `createEntity(options: EntityAgentOptions)` - Create new entity from template
- `listEntities(entityType: 'character' | 'location' | 'item')` - List entities by type
- `getEntity(entityType, entityName)` - Get entity information
- `validateEntity(entityType, entityName)` - Validate entity file
- `editEntity(entityType, entityName, updates)` - Edit entity (to be implemented)
- `deleteEntity(entityType, entityName)` - Delete entity (to be implemented)
- `searchEntities(query, entityType?)` - Search entities (to be implemented)
- `backupEntity(entityType, entityName)` - Backup entity (to be implemented)

**FileUtils Class** [Source: src/utils/fileUtils.ts]:
- `createCharacterFile(character: Character, filename?)` - Create character file
- `createLocationFile(location: Location, filename?)` - Create location file
- `createItemFile(item: Item, filename?)` - Create item file
- `validateEntityFile(filePath, entityType)` - Validate entity file structure
- `readEntityFile(filePath)` - Read and parse entity file
- `updateEntityFile(filePath, updates)` - Update entity file (to be implemented)
- `deleteEntityFile(filePath)` - Delete entity file (to be implemented)
- `backupEntityFile(filePath)` - Backup entity file (to be implemented)

### File Locations
Based on the source tree structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify:**
- `src/agents/entityAgent.ts` - Add missing entity management methods
- `src/utils/fileUtils.ts` - Add entity editing, deletion, search, and backup methods
- `src/agents/commandRouter.ts` - Add new entity command handlers
- `src/__tests__/entityAgent.test.ts` - Add comprehensive tests for new functionality
- `src/__tests__/fileUtils.test.ts` - Add tests for new file utility methods

**Existing Files to Integrate With:**
- `entities/characters/` - Character entity files directory
- `entities/locations/` - Location entity files directory
- `entities/items/` - Item entity files directory
- `.jester/templates/character.md` - Character template file
- `.jester/templates/location.md` - Location template file
- `.jester/templates/item.md` - Item template file

### Testing Requirements
**Test file locations**: 
- `src/__tests__/entityAgent.test.ts` (new test file)
- `src/__tests__/fileUtils.test.ts` (update existing)

**Testing frameworks**: Jest [Source: architecture/tech-stack.md#Development Tools]

**Test standards**: 
- Unit tests for all new entity management methods
- Integration tests for entity CRUD operations
- Validation tests for entity file operations
- Error handling tests for edge cases
- Performance tests for search operations

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: Node.js with TypeScript
- **Package Manager**: npm
- **File System**: Node.js fs module with fs-extra
- **Dependencies**: @types/node, yaml, fs-extra

**Coding Standards** [Source: architecture/coding-standards.md#TypeScript Standards]:
- Use strict TypeScript configuration
- Prefer interfaces over types for object shapes
- Use explicit return types for public methods
- Follow camelCase for variables and functions
- Use PascalCase for classes and interfaces

**Error Handling** [Source: architecture/coding-standards.md#Error Handling]:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

### Entity Management Features to Implement
**Entity Creation Enhancements**:
- Interactive prompts for required information
- Template validation before file creation
- Duplicate name checking
- Automatic metadata generation

**Entity Editing**:
- Update entity properties while preserving structure
- Validate changes against template requirements
- Update metadata (last_modified, version)
- Preserve wiki-link integrity

**Entity Deletion**:
- Safe deletion with confirmation
- Update all references in other entity files
- Remove from wiki-link index
- Create backup before deletion

**Entity Search**:
- Search by name, type, or content
- Case-insensitive search
- Partial matching support
- Search result ranking

**Entity Listing**:
- Organized by type and directory
- Sort by name, creation date, or last modified
- Display metadata and statistics
- Filter by entity type

**Entity Validation**:
- Check required fields are present
- Validate template structure
- Check wiki-link integrity
- Report validation errors with suggestions

**Entity Backup**:
- Create timestamped backup files
- Preserve original file structure
- Store backups in dedicated directory
- Automatic cleanup of old backups

## Tasks / Subtasks

### Task 1: Enhance Entity Creation (AC: 1)
- [ ] 1.1. Add interactive prompts for required entity information
- [ ] 1.2. Implement duplicate name checking before creation
- [ ] 1.3. Add template validation before file generation
- [ ] 1.4. Enhance error handling for creation failures
- [ ] 1.5. Add confirmation prompts for entity creation

### Task 2: Implement Entity Editing (AC: 2)
- [ ] 2.1. Create updateEntityFile method in FileUtils
- [ ] 2.2. Add editEntity method to EntityAgent
- [ ] 2.3. Implement property validation for updates
- [ ] 2.4. Add metadata update functionality (last_modified, version)
- [ ] 2.5. Preserve wiki-link integrity during edits
- [ ] 2.6. Add edit command handler to CommandRouter

### Task 3: Implement Entity Deletion (AC: 3)
- [ ] 3.1. Create deleteEntityFile method in FileUtils
- [ ] 3.2. Add deleteEntity method to EntityAgent
- [ ] 3.3. Implement reference cleanup (wiki-links)
- [ ] 3.4. Add confirmation prompts for deletion
- [ ] 3.5. Create backup before deletion
- [ ] 3.6. Add delete command handler to CommandRouter

### Task 4: Implement Entity Search (AC: 4)
- [ ] 4.1. Create searchEntities method in EntityAgent
- [ ] 4.2. Implement content-based search functionality
- [ ] 4.3. Add case-insensitive and partial matching
- [ ] 4.4. Implement search result ranking
- [ ] 4.5. Add search command handler to CommandRouter

### Task 5: Enhance Entity Listing (AC: 5)
- [ ] 5.1. Add sorting options (name, date, modified)
- [ ] 5.2. Implement filtering by entity type
- [ ] 5.3. Add metadata display in listings
- [ ] 5.4. Implement pagination for large entity sets
- [ ] 5.5. Add statistics display (count, types)

### Task 6: Enhance Entity Validation (AC: 6)
- [ ] 6.1. Expand validation to check all required fields
- [ ] 6.2. Add wiki-link integrity checking
- [ ] 6.3. Implement validation error reporting with suggestions
- [ ] 6.4. Add batch validation for multiple entities
- [ ] 6.5. Create validation report generation

### Task 7: Implement Entity Backup (AC: 7)
- [ ] 7.1. Create backupEntityFile method in FileUtils
- [ ] 7.2. Add backupEntity method to EntityAgent
- [ ] 7.3. Implement timestamped backup naming
- [ ] 7.4. Create backup directory management
- [ ] 7.5. Add automatic cleanup of old backups
- [ ] 7.6. Add backup command handler to CommandRouter

### Task 8: Integration and Testing (AC: All)
- [ ] 8.1. Integrate all new methods with existing command router
- [ ] 8.2. Create comprehensive unit tests for new functionality
- [ ] 8.3. Add integration tests for entity management workflows
- [ ] 8.4. Test error handling and edge cases
- [ ] 8.5. Validate wiki-link system integration
- [ ] 8.6. Performance test search and listing operations

## Project Structure Notes
Current project structure is well-aligned with entity management requirements:
- Entity directories and templates are established and functional
- File utilities include basic entity creation and validation
- Entity agent provides foundation for CRUD operations
- Command router supports entity commands
- Wiki-link system is integrated and ready for entity management
- Testing framework is in place for comprehensive test coverage

## Change Log
- 2025-01-21: Initial story draft created

## Dev Agent Record
*This section will be populated by the Dev Agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*
