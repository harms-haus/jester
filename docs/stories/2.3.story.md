# Story 2.3: Entity Creation and Management

## Story Information
- **Epic**: 2 - Entity Management System
- **Story Number**: 2.3
- **Status**: Draft
- **Created**: 2025-01-21
- **Last Modified**: 2025-01-21

## Story Statement

As a **parent building a story universe**,
I want **to easily create and manage entity files**,
so that **I can build a rich knowledge base for my stories**.

## Acceptance Criteria

1. **New entity creation** prompts for required information and LLM generates files per prompt rules
2. **Entity editing** allows modification of existing entity information via LLM following prompt instructions
3. **Entity deletion** removes files and updates all references through LLM operations per prompt rules
4. **Entity search** finds entities by name, type, or content via LLM analysis following prompt instructions
5. **Entity listing** shows all entities organized by type and directory through LLM response per prompt rules
6. **Entity validation** ensures consistency and completeness via LLM checking following prompt instructions
7. **Entity backup** creates copies before major changes through LLM operations per prompt rules
8. **Entity import** converts unstructured .md files or directories (up to 10 files) into structured format via LLM parsing per prompt rules

## Dev Notes

### Previous Story Insights
Story 2.1 established the entity directory structure and templates, while Story 2.2 implemented the wiki-style linking system. The foundation is solid with:
- Entity directories and templates are in place and functional
- Wiki-link system with bidirectional linking is complete
- Entity management agent provides prompt-based CRUD operations
- Command system supports entity commands through agent responses

### Prompt-Based Agent Approach
This story implements entity creation and management through **prompt-based agents** rather than TypeScript classes. The entity management agent will use prompts and rules to:

- Create, edit, delete, and search entities
- Validate entity files and maintain consistency
- Provide entity listing and backup functionality
- Handle all entity operations through agent responses

**Agent Behavior Rules** [Source: architecture/agent-patterns.md#Prompt-Based Agents]:
- Entity agent responds to `/entity` commands through prompt-based rules
- File operations handled through agent prompts, not TypeScript classes
- Entity validation managed by agent persona and behavior rules
- Error handling through prompt-based responses and suggestions

### Data Models
Based on architecture documentation, the following data structures will be used for entity management:

**Entity Structure** [Source: architecture/data-models.md#Core Data Structures]:
```yaml
id: string
name: string
type: 'character' | 'location' | 'item'
description: string
properties: Record<string, any>
relationships: string[]
last_used: string
usage_count: number
```

**EntityFile Structure** [Source: architecture/data-models.md#Core Data Structures]:
```yaml
path: string
name: string
type: 'character' | 'location' | 'item'
content: string
metadata:
  created_at: string
  last_modified: string
  version: number
```

### Agent Command Specifications
**Entity Management Commands** [Source: architecture/agent-patterns.md#Agent Commands]:
- `/entity create <character|location|item> <name> [options]` - Create new entity through agent prompts
- `/entity list <character|location|item>` - List entities by type through agent responses
- `/entity get <character|location|item> <name>` - Get entity information through agent prompts
- `/entity validate <character|location|item> <name>` - Validate entity file through agent rules
- `/entity edit <character|location|item> <name> [options]` - Edit entity through agent prompts
- `/entity delete <character|location|item> <name> [options]` - Delete entity through agent responses
- `/entity search <query> [options]` - Search entities through agent prompts
- `/entity backup <character|location|item> <name>` - Backup entity through agent rules
- `/edit import <file-path-or-directory> [entity-type]` - Import unstructured entity file or directory (up to 10 files) and convert to structured format

### Agent Behavior Specifications
**Entity Agent Prompts** [Source: architecture/agent-patterns.md#Agent Behavior]:
- Entity creation prompts for interactive information gathering
- Entity editing prompts for modification and validation
- Entity deletion prompts for safe removal and reference cleanup
- Entity search prompts for content-based discovery
- Entity listing prompts for organized display
- Entity validation prompts for consistency checking
- Entity backup prompts for safety and versioning
- Entity import prompts for parsing and converting unstructured content

### File Locations
Based on the source tree structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify:**
- `src/agents/entityAgent.ts` - Add missing entity management methods
- `src/utils/fileUtils.ts` - Add entity editing, deletion, search, and backup methods
- `src/agents/commandRouter.ts` - Add new entity command handlers
- `src/__tests__/entityAgent.test.ts` - Add comprehensive tests for new functionality
- `src/__tests__/fileUtils.test.ts` - Add tests for new file utility methods

**Existing Files to Integrate With:**
- `entities/characters/` - Character entity files directory
- `entities/locations/` - Location entity files directory
- `entities/items/` - Item entity files directory
- `.jester/templates/character.md` - Character template file
- `.jester/templates/location.md` - Location template file
- `.jester/templates/item.md` - Item template file

### Testing Requirements
**Test file locations**: 
- `src/__tests__/entityAgent.test.ts` (new test file)
- `src/__tests__/fileUtils.test.ts` (update existing)

**Testing frameworks**: Jest [Source: architecture/tech-stack.md#Development Tools]

**Test standards**: 
- Unit tests for all new entity management methods
- Integration tests for entity CRUD operations
- Validation tests for entity file operations
- Error handling tests for edge cases
- Performance tests for search operations

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: Node.js with TypeScript
- **Package Manager**: npm
- **File System**: Node.js fs module with fs-extra
- **Dependencies**: @types/node, yaml, fs-extra

**Coding Standards** [Source: architecture/coding-standards.md#TypeScript Standards]:
- Use strict TypeScript configuration
- Prefer interfaces over types for object shapes
- Use explicit return types for public methods
- Follow camelCase for variables and functions
- Use PascalCase for classes and interfaces

**Error Handling** [Source: architecture/coding-standards.md#Error Handling]:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

### Entity Management Features to Implement
**Entity Creation Enhancements**:
- Interactive prompts for required information
- Template validation before file creation
- Duplicate name checking
- Automatic metadata generation

**Entity Editing**:
- Update entity properties while preserving structure
- Validate changes against template requirements
- Update metadata (last_modified, version)
- Preserve wiki-link integrity

**Entity Deletion**:
- Safe deletion with confirmation
- Update all references in other entity files
- Remove from wiki-link index
- Create backup before deletion

**Entity Search**:
- Search by name, type, or content
- Case-insensitive search
- Partial matching support
- Search result ranking

**Entity Listing**:
- Organized by type and directory
- Sort by name, creation date, or last modified
- Display metadata and statistics
- Filter by entity type

**Entity Validation**:
- Check required fields are present
- Validate template structure
- Check wiki-link integrity
- Report validation errors with suggestions

**Entity Backup**:
- Create timestamped backup files
- Preserve original file structure
- Store backups in dedicated directory
- Automatic cleanup of old backups

**Entity Import**:
- Read unstructured .md file or scan directory containing character/location/item data
- For directories: Process up to 10 files, skip duplicates and already structured files
- Use LLM to analyze content and extract relevant information
- Map extracted data to appropriate template fields
- Generate structured entity file using existing templates
- Validate imported content for completeness and consistency
- Provide user feedback on import success and any issues

**Import Command Behavior**:
- `/edit import <file-path>` - Auto-detect entity type and import single file
- `/edit import <directory-path>` - Process directory (up to 10 files), auto-detect types
- `/edit import <file-path> character` - Force character import
- `/edit import <file-path> location` - Force location import  
- `/edit import <file-path> item` - Force item import
- `/edit import <directory-path> character` - Process directory, force all as characters

## Tasks / Subtasks

### Task 1: Create Entity Management Agent (AC: 1, 2, 3, 4, 5, 6, 7)
- [ ] 1.1. Create `.jester/agents/entity.md` with YAML configuration
- [ ] 1.2. Define agent persona for entity management operations
- [ ] 1.3. Create prompt rules for entity creation, editing, deletion
- [ ] 1.4. Define behavior rules for entity search and listing
- [ ] 1.5. Implement agent response patterns for all entity operations

### Task 2: Implement Prompt-Based Entity Creation (AC: 1)
- [ ] 2.1. Create prompts for interactive entity information gathering
- [ ] 2.2. Define rules for duplicate name checking
- [ ] 2.3. Implement agent responses for template validation
- [ ] 2.4. Create prompts for error handling and suggestions
- [ ] 2.5. Define confirmation prompts for entity creation

### Task 3: Implement Prompt-Based Entity Editing (AC: 2)
- [ ] 3.1. Create prompts for entity modification operations
- [ ] 3.2. Define rules for property validation during updates
- [ ] 3.3. Implement agent responses for metadata updates
- [ ] 3.4. Create prompts for preserving wiki-link integrity
- [ ] 3.5. Define error handling for edit operations

### Task 4: Implement Prompt-Based Entity Deletion (AC: 3)
- [ ] 4.1. Create prompts for safe entity deletion
- [ ] 4.2. Define rules for reference cleanup (wiki-links)
- [ ] 4.3. Implement agent responses for confirmation prompts
- [ ] 4.4. Create prompts for backup creation before deletion
- [ ] 4.5. Define error handling for deletion operations

### Task 5: Implement Prompt-Based Entity Search (AC: 4)
- [ ] 5.1. Create prompts for content-based entity search
- [ ] 5.2. Define rules for case-insensitive and partial matching
- [ ] 5.3. Implement agent responses for search result ranking
- [ ] 5.4. Create prompts for search result display
- [ ] 5.5. Define error handling for search operations

### Task 6: Implement Prompt-Based Entity Listing (AC: 5)
- [ ] 6.1. Create prompts for entity listing and organization
- [ ] 6.2. Define rules for sorting and filtering options
- [ ] 6.3. Implement agent responses for metadata display
- [ ] 6.4. Create prompts for pagination and statistics
- [ ] 6.5. Define error handling for listing operations

### Task 7: Implement Prompt-Based Entity Validation (AC: 6)
- [ ] 7.1. Create prompts for comprehensive entity validation
- [ ] 7.2. Define rules for wiki-link integrity checking
- [ ] 7.3. Implement agent responses for validation error reporting
- [ ] 7.4. Create prompts for batch validation operations
- [ ] 7.5. Define error handling for validation operations

### Task 8: Implement Prompt-Based Entity Backup (AC: 7)
- [ ] 8.1. Create prompts for entity backup operations
- [ ] 8.2. Define rules for timestamped backup naming
- [ ] 8.3. Implement agent responses for backup directory management
- [ ] 8.4. Create prompts for automatic cleanup of old backups
- [ ] 8.5. Define error handling for backup operations

### Task 9: Implement Prompt-Based Entity Import (AC: 8)
- [ ] 9.1. Create prompts for parsing unstructured .md files and directory scanning
- [ ] 9.2. Define rules for LLM-based content analysis and enrichment
- [ ] 9.3. Implement agent responses for template population and batch processing
- [ ] 9.4. Create prompts for validation and error handling during import
- [ ] 9.5. Define behavior rules for import confirmation and user feedback
- [ ] 9.6. Implement duplicate detection and file selection logic
- [ ] 9.7. Create batch processing progress tracking and summary reporting

### Task 10: Integration and Testing (AC: All)
- [ ] 10.1. Integrate entity agent with LightRAG MCP client
- [ ] 10.2. Test agent responses for all entity operations
- [ ] 10.3. Validate prompt-based file operations
- [ ] 10.4. Test agent error handling and suggestions
- [ ] 10.5. Verify agent integration with command system

## Project Structure Notes
Current project structure is well-aligned with entity management requirements:
- Entity directories and templates are established and functional
- File utilities include basic entity creation and validation
- Entity agent provides foundation for CRUD operations
- Command router supports entity commands
- Wiki-link system is integrated and ready for entity management
- Testing framework is in place for comprehensive test coverage

### Completion Notes List
- [ ] Entity management agent created with comprehensive CRUD operations
- [ ] Prompt-based entity creation with interactive information gathering
- [ ] Agent prompts for entity editing, deletion, and search operations
- [ ] Entity listing and validation through agent responses
- [ ] Entity backup functionality through agent prompts
- [ ] Agent integration with LightRAG MCP client completed
- [ ] All acceptance criteria met through prompt-based approach

### File List
**Files to Create:**
- `.jester/agents/entity.md` - Entity management agent definition
- `.jester/prompts/entity-creation.md` - Entity creation prompts
- `.jester/prompts/entity-editing.md` - Entity editing prompts
- `.jester/prompts/entity-deletion.md` - Entity deletion prompts
- `.jester/prompts/entity-search.md` - Entity search prompts
- `.jester/prompts/entity-listing.md` - Entity listing prompts
- `.jester/prompts/entity-validation.md` - Entity validation prompts
- `.jester/prompts/entity-backup.md` - Entity backup prompts
- `.jester/prompts/entity-import.md` - Entity import and parsing prompts

**Existing Files to Use:**
- `src/clients/lightragClient.ts` - LightRAG MCP client integration
- `src/utils/fileUtils.ts` - Basic file operations utilities (keep minimal)
- `src/utils/errorHandler.ts` - Error handling system (keep minimal)

## Change Log
- 2025-01-21: Story updated to reflect prompt-based agent approach
- 2025-01-21: Removed TypeScript implementation references
- 2025-01-21: Added prompt-based agent task structure for entity management
- 2025-01-21: Updated file locations for agent-based approach

## Dev Agent Record
*This section will be populated by the Dev Agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*
