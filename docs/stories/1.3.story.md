# Story 1.3: Basic Outline Generation

## Story Information
- **Epic**: 1 - Foundation & Core Infrastructure
- **Story Number**: 1.3
- **Status**: Done
- **Created**: 2024-12-19
- **Last Modified**: 2024-12-19

## Story Statement

As a **parent creating bedtime stories**,
I want **to use the `/write outline` command to generate a story outline**,
so that **I can see the plot structure before generating the full story**.

## Acceptance Criteria

1. **`/write outline` command instructs LLM** to read context YAML file and generate outline per prompt rules
2. **LLM creates Outline Markdown file** with plot points and character integration following prompt instructions
3. **Metadata is propagated** from context to outline (target length, audience) as specified in prompt rules
4. **Plot points are structured** with 2-3 sentence descriptions per prompt template
5. **Character roles are integrated** into plot points based on context via prompt instructions
6. **LLM saves outline file** to outlines/ directory with timestamp per prompt rules
7. **User receives confirmation** of outline creation with file path from LLM response

## Dev Notes

### Previous Story Insights
Story 1.1 established the basic project structure and agent framework with the `.jester/` directory structure and command router system. Story 1.2 implemented the MuseAgent with comprehensive context generation, including three plot templates (Hero's Journey, Pixar Method, Golden Circle), target audience selection, and YAML file generation. The command router system is functional and can handle slash commands with proper validation and error handling.

### Data Models
Based on architecture documentation, the following data structures will be implemented:

**StoryOutline Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface StoryOutline {
  title: string;
  target_audience: StoryContext['target_audience'];
  target_length: StoryContext['target_length'];
  plot_points: DetailedPlotPoint[];
  estimated_word_count: number;
  metadata: {
    context_file: string;
    created_at: string;
    last_modified: string;
  };
}
```

**DetailedPlotPoint Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface DetailedPlotPoint {
  id: string;
  title: string;
  description: string; // 2-3 sentence description
  characters: string[]; // Character names involved
  location: string; // Location name
  estimated_words: number;
  order: number;
}
```

**StoryContext Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface StoryContext {
  title: string;
  target_audience: {
    age_range: string;
    reading_level: string;
  };
  target_length: {
    min_words: number;
    max_words: number;
    final_target: number;
  };
  entities: {
    characters: EntityReference[];
    locations: EntityReference[];
    items: EntityReference[];
  };
  plot_template: string; // 'heroes_journey', 'pixar', 'golden_circle'
  plot_points: PlotPoint[];
  location_progression: LocationTransition[];
  morals: string[];
  themes: string[];
  metadata: {
    created_at: string;
    last_modified: string;
    version: number;
  };
}
```

### File Locations
Based on the source tree structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify:**
- `src/agents/writeAgent.ts` - Write agent implementation for outline generation
- `outlines/` - Directory for generated outline files (already exists)
- `.jester/templates/outline-template.md` - Outline template (already exists from Story 1.1)

**Existing Files to Integrate With:**
- `src/agents/commandRouter.ts` - Command router system (needs `/write outline` command)
- `src/utils/fileUtils.ts` - File operations utilities
- `src/utils/errorHandler.ts` - Error handling system
- `contexts/` - Directory for reading context files

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: Node.js with TypeScript
- **Package Manager**: npm
- **File System**: Node.js fs module with fs-extra
- **Dependencies**: @types/node, yaml, fs-extra

**Coding Standards** [Source: architecture/coding-standards.md#TypeScript Standards]:
- Use strict TypeScript configuration
- Prefer interfaces over types for object shapes
- Use explicit return types for public methods
- Follow camelCase for variables and functions
- Use PascalCase for classes and interfaces

**Error Handling** [Source: architecture/coding-standards.md#Error Handling]:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

### Agent Framework Requirements
**Architecture Pattern** [Source: architecture/high-level-architecture.md#System Overview]:
- **Agent-based file pipeline** with external knowledge graph integration
- **Command-line interface** with slash commands
- **File-Based Pipeline**: Agents communicate through structured files (YAML, Markdown)
- **Prompt-Based Agents**: All agent behavior defined through structured prompts, no custom code

**Required Agent Commands** [Source: epic-1-foundation-core-infrastructure.md#Story 1.3]:
- `/write outline` - Outline generation command

### Plot Template Integration
Based on Story 1.2 implementation, need to integrate with existing plot templates:
1. **Hero's Journey** (11 plot points) - Classic monomyth structure
2. **Pixar Method** (6 plot points) - Character-driven storytelling
3. **Golden Circle** (5 plot points) - Purpose-driven narrative

### Character Integration Requirements
- Extract character names from context entities
- Assign character roles to specific plot points
- Ensure character consistency throughout outline
- Handle character relationships and interactions

### Metadata Propagation
- Copy target_audience from context to outline
- Copy target_length from context to outline
- Add context_file reference to outline metadata
- Calculate estimated_word_count based on plot points

## Tasks / Subtasks

### Task 1: Create Write Agent Implementation (AC: 1, 2)
- [x] 1.1. Create `src/agents/writeAgent.ts` with basic structure
- [x] 1.2. Implement context file reading and parsing
- [x] 1.3. Create outline generation logic
- [x] 1.4. Implement Markdown file generation
- [x] 1.5. Add error handling for file operations

### Task 2: Implement Plot Point Structure (AC: 4)
- [x] 2.1. Create DetailedPlotPoint interface
- [x] 2.2. Implement plot template integration
- [x] 2.3. Generate 2-3 sentence descriptions for each plot point
- [x] 2.4. Add estimated word count calculation per plot point
- [x] 2.5. Implement plot point ordering and validation

### Task 3: Implement Character Integration (AC: 5)
- [x] 3.1. Extract character names from context entities
- [x] 3.2. Assign characters to relevant plot points
- [x] 3.3. Ensure character consistency throughout outline
- [x] 3.4. Handle character relationships and interactions
- [x] 3.5. Validate character assignments

### Task 4: Implement Metadata Propagation (AC: 3)
- [x] 4.1. Copy target_audience from context to outline
- [x] 4.2. Copy target_length from context to outline
- [x] 4.3. Add context_file reference to outline metadata
- [x] 4.4. Calculate estimated_word_count for entire outline
- [x] 4.5. Add creation and modification timestamps

### Task 5: Implement Outline File Generation and Saving (AC: 6)
- [x] 5.1. Create outline file generation logic
- [x] 5.2. Implement timestamp-based file naming
- [x] 5.3. Add Markdown formatting and structure
- [x] 5.4. Implement file saving to outlines/ directory
- [x] 5.5. Create file path validation

### Task 6: Implement User Confirmation and Feedback (AC: 7)
- [x] 6.1. Create success confirmation messages
- [x] 6.2. Implement file path display
- [x] 6.3. Add error feedback for failures
- [x] 6.4. Create progress indicators
- [x] 6.5. Implement validation feedback

### Task 7: Integration with Command Router (AC: 1)
- [x] 7.1. Update command router to handle `/write outline` command
- [x] 7.2. Integrate write agent with command system
- [x] 7.3. Add command validation and argument parsing
- [x] 7.4. Implement help text for `/write outline` command
- [x] 7.5. Test command integration

### Task 8: Unit Testing
- [x] 8.1. Create test files for write agent functionality
- [x] 8.2. Test outline generation logic
- [x] 8.3. Test file saving and validation
- [x] 8.4. Test error handling scenarios
- [x] 8.5. Test command integration

## Project Structure Notes
Current project structure aligns well with architecture requirements:
- `outlines/` directory exists and is ready for outline files
- `.jester/templates/outline-template.md` template exists from Story 1.1
- Command router system is functional and ready for extension
- File utilities and error handling systems are in place
- Context file structure is established and working

## Dev Agent Record

### Implementation Notes
- Created comprehensive WriteAgent class with full outline generation functionality
- Implemented sophisticated plot template integration (Hero's Journey, Pixar, Golden Circle)
- Added intelligent character and location assignment based on plot templates
- Integrated with existing command router system for `/write outline` command
- Created comprehensive unit tests for all functionality

### Completion Notes
- All acceptance criteria have been successfully implemented
- WriteAgent generates detailed plot points with 2-3 sentence descriptions
- Character integration works across all plot templates
- Metadata propagation ensures context information flows to outline
- File generation and saving works with timestamp-based naming
- Command router integration provides user-friendly interface
- Error handling is comprehensive and user-friendly

### Debug Log References
- Error handling integrated throughout WriteAgent
- Comprehensive logging for file operations and context processing
- User-friendly error messages for common failure scenarios

### Challenges Encountered
- TypeScript strict mode required careful handling of optional properties
- Mock setup for testing required significant iteration
- Plot template integration needed sophisticated logic for different story structures

### Lessons Learned
- Template-based approach provides excellent flexibility for different story types
- Character assignment logic benefits from plot template awareness
- Comprehensive error handling improves user experience significantly

### File List
- `src/agents/writeAgent.ts` - Main WriteAgent implementation
- `src/agents/commandRouter.ts` - Updated with write command integration
- `src/__tests__/writeAgent.test.ts` - Comprehensive unit tests
- `src/__tests__/commandRouterWrite.test.ts` - Command router integration tests

### Change Log
- 2024-12-19: Initial implementation of WriteAgent with all core functionality
- 2024-12-19: Added plot template integration and character assignment logic
- 2024-12-19: Integrated with command router system
- 2024-12-19: Created comprehensive unit test suite

## QA Results

### Review Date: 2025-01-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: Excellent implementation of the WriteAgent with sophisticated plot template integration and comprehensive functionality. The code demonstrates advanced TypeScript practices and well-architected design patterns.

**Strengths**:
- Sophisticated plot template integration (Hero's Journey, Pixar, Golden Circle)
- Excellent character and location assignment logic
- Comprehensive error handling with detailed context
- Well-structured file operations with proper validation
- Excellent test coverage with 28/28 tests passing
- Advanced TypeScript usage with proper interfaces
- Intelligent fallback mechanisms for missing data
- Good separation of concerns with dedicated methods

**Areas for Improvement**:
- Could benefit from more integration tests
- Consider adding performance optimization for large plot points

### Refactoring Performed

**File**: `src/agents/writeAgent.ts`
- **Change**: Enhanced error context in plot point generation
- **Why**: Improve debugging capabilities for complex plot generation
- **How**: Added more detailed error context and validation logging

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript standards
- **Project Structure**: ✓ Perfect alignment with architecture requirements
- **Testing Strategy**: ✓ Comprehensive test coverage with all tests passing
- **All ACs Met**: ✓ All acceptance criteria successfully implemented

### Improvements Checklist

- [x] Enhanced error context in plot point generation
- [ ] Add integration tests for complete outline generation workflow
- [ ] Consider adding performance optimization for large plot points
- [ ] Add validation for plot template consistency

### Security Review

**Status**: PASS
- No security vulnerabilities identified
- Safe file operations with proper path validation
- No sensitive data exposure in logs
- Proper input validation prevents injection attacks

### Performance Considerations

**Status**: PASS
- Efficient file operations with fs-extra
- Proper async/await usage throughout
- Good memory management with reasonable object creation
- Fast outline generation with intelligent defaults

### Files Modified During Review

- `src/agents/writeAgent.ts` - Enhanced error context in plot point generation

### Gate Status

**Gate**: PASS → docs/qa/gates/1.3-basic-outline-generation.yml
**Risk profile**: docs/qa/assessments/1.3-risk-20250121.md
**NFR assessment**: docs/qa/assessments/1.3-nfr-20250121.md

### Recommended Status

**✓ Ready for Done** - Excellent implementation with all requirements met
