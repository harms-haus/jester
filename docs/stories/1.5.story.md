# Story 1.5: Basic Edit Functionality

## Story Information
- **Epic**: 1 - Foundation & Core Infrastructure
- **Story Number**: 1.5
- **Status**: Done
- **Created**: 2024-12-19
- **Last Modified**: 2024-12-19

## Story Statement

As a **parent creating bedtime stories**,
I want **to use the `/edit` command to modify outlines and stories**,
so that **I can refine the content without regenerating from scratch**.

## Acceptance Criteria

1. **`/edit` command accepts file path and edit instructions** for outlines and stories
2. **LLM follows Edit prompt rules** to apply edit operations to the specified file without regeneration
3. **File integrity is maintained** after edit operations per prompt instructions
4. **User can edit character names, plot points, and story content** through LLM following prompt rules
5. **LLM saves edit changes** to the original file per prompt instructions
6. **User receives confirmation** of successful edit operations from LLM response
7. **LLM creates backup files** before major edit operations per prompt rules

## Dev Notes

### Previous Story Insights
Story 1.1 established the basic project structure and agent framework with the `.jester/` directory structure and command router system. Story 1.2 implemented the MuseAgent with comprehensive context generation, including three plot templates (Hero's Journey, Pixar Method, Golden Circle), target audience selection, and YAML file generation. Story 1.3 implemented the WriteAgent with outline generation functionality, including plot template integration, character assignment, and metadata propagation. Story 1.4 implemented the WriteAgent with story generation functionality, including outline file reading, story content generation, and file saving. The command router system is functional and can handle slash commands with proper validation and error handling.

### Data Models
Based on architecture documentation, the following data structures will be used for edit operations:

**StoryContext Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface StoryContext {
  title: string;
  target_audience: {
    age_range: string;
    reading_level: string;
  };
  target_length: {
    min_words: number;
    max_words: number;
    final_target: number; // After editing
  };
  entities: {
    characters: EntityReference[];
    locations: EntityReference[];
    items: EntityReference[];
  };
  plot_template: string; // 'heroes_journey', 'pixar', 'golden_circle'
  plot_points: PlotPoint[];
  location_progression: LocationTransition[];
  morals: string[];
  themes: string[];
  metadata: {
    created_at: string;
    last_modified: string;
    version: number;
  };
}
```

**StoryOutline Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface StoryOutline {
  title: string;
  target_audience: StoryContext['target_audience'];
  target_length: StoryContext['target_length'];
  plot_points: DetailedPlotPoint[];
  estimated_word_count: number;
  metadata: {
    context_file: string;
    created_at: string;
    last_modified: string;
  };
}
```

**Story Interface** [Source: architecture/data-models.md#Core Data Structures]:
```typescript
interface Story {
  title: string;
  content: string;
  word_count: number;
  metadata: {
    outline_file: string;
    context_file: string;
    created_at: string;
    last_modified: string;
    reading_time_minutes: number;
  };
}
```

### File Locations
Based on the source tree structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify:**
- `src/agents/editAgent.ts` - New EditAgent implementation for file editing functionality
- `outlines/` - Directory for reading and modifying outline files (already exists)
- `stories/` - Directory for reading and modifying story files (already exists)
- `contexts/` - Directory for reading and modifying context files (already exists)

**Existing Files to Integrate With:**
- `src/agents/commandRouter.ts` - Command router system (needs `/edit` command)
- `src/utils/fileUtils.ts` - File operations utilities for backup and validation
- `src/utils/errorHandler.ts` - Error handling system

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: Node.js with TypeScript
- **Package Manager**: npm
- **File System**: Node.js fs module with fs-extra
- **Dependencies**: @types/node, yaml, fs-extra

**Coding Standards** [Source: architecture/coding-standards.md#TypeScript Standards]:
- Use strict TypeScript configuration
- Prefer interfaces over types for object shapes
- Use explicit return types for public methods
- Follow camelCase for variables and functions
- Use PascalCase for classes and interfaces

**Error Handling** [Source: architecture/coding-standards.md#Error Handling]:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

### Agent Framework Requirements
**Architecture Pattern** [Source: architecture/architectural-patterns.md#Agent-Based Architecture]:
- **Agent-based file pipeline** with specialized agents for specific responsibilities
- **Command-line interface** with slash commands
- **File-Based Pipeline**: Agents communicate through structured files (YAML, Markdown)
- **Prompt-Based Agents**: All agent behavior defined through structured prompts, no custom code

**Required Agent Commands** [Source: epic-1-foundation-core-infrastructure.md#Story 1.5]:
- `/edit` - File editing command for outlines and stories

### Edit Functionality Workflow
Based on the component architecture [Source: architecture/architectural-patterns.md#File-Based Pipeline]:
1. User runs `/edit` command with file path and edit instructions
2. Edit Agent reads the specified file (outline, story, or context)
3. Agent parses the file content and validates structure
4. Agent applies edit operations based on user instructions
5. Agent creates backup file before making changes
6. Agent saves modified content to original file
7. User receives confirmation of successful edit operations

### File Type Support
The edit functionality will support:
- **Context files** (YAML format) - Character names, plot points, themes, metadata
- **Outline files** (Markdown format) - Plot structure, character integration, descriptions
- **Story files** (Markdown format) - Story content, title, summary, narrative

### Backup and Safety
- Create timestamped backup files before major edit operations
- Validate file integrity after edit operations
- Maintain original file structure and formatting
- Provide rollback capability through backup files

### Testing
**Test file location**: `src/__tests__/editAgent.test.ts` (new test file)
**Testing frameworks**: Jest [Source: architecture/tech-stack.md#Development Tools]
**Test standards**: Unit tests for all edit functionality, integration tests for command router, file operation tests

## Tasks / Subtasks

### Task 1: Create EditAgent Implementation (AC: 1, 2)
- [x] 1.1. Create new EditAgent class in `src/agents/editAgent.ts`
- [x] 1.2. Implement file reading and parsing for YAML and Markdown files
- [x] 1.3. Create edit operation processing logic
- [x] 1.4. Implement file validation and integrity checks
- [x] 1.5. Add error handling for edit operations

### Task 2: Implement File Type Support (AC: 3, 4)
- [x] 2.1. Support context file editing (YAML format)
- [x] 2.2. Support outline file editing (Markdown format)
- [x] 2.3. Support story file editing (Markdown format)
- [x] 2.4. Implement character name editing across all file types
- [x] 2.5. Implement plot point editing for outlines and contexts
- [x] 2.6. Implement story content editing for narrative text

### Task 3: Implement Backup and Safety Features (AC: 7)
- [x] 3.1. Create backup file generation before edit operations
- [x] 3.2. Implement timestamped backup file naming
- [x] 3.3. Add file integrity validation after edits
- [x] 3.4. Create rollback functionality using backup files
- [x] 3.5. Implement file permission and access validation

### Task 4: Implement User Interface and Feedback (AC: 5, 6)
- [x] 4.1. Create success confirmation messages
- [x] 4.2. Implement edit operation progress indicators
- [x] 4.3. Add error feedback for failed edit operations
- [x] 4.4. Create file path validation and error messages
- [x] 4.5. Implement edit instruction parsing and validation

### Task 5: Integration with Command Router (AC: 1)
- [x] 5.1. Update command router to handle `/edit` command
- [x] 5.2. Integrate edit functionality with command system
- [x] 5.3. Add command validation and argument parsing
- [x] 5.4. Implement help text for `/edit` command
- [x] 5.5. Test command integration

### Task 6: Unit Testing
- [x] 6.1. Create test file `src/__tests__/editAgent.test.ts`
- [x] 6.2. Test edit operations for all file types
- [x] 6.3. Test backup file creation and validation
- [x] 6.4. Test error handling scenarios
- [x] 6.5. Test command integration

## Project Structure Notes
Current project structure aligns well with architecture requirements:
- `outlines/`, `stories/`, and `contexts/` directories exist and are ready for edit operations
- Command router system is functional and ready for extension
- File utilities and error handling systems are in place
- Agent framework is established and ready for new EditAgent

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (Full Stack Developer Agent)

### Debug Log References
- EditAgent implementation completed successfully
- All TypeScript compilation errors resolved
- All unit tests passing (14/14)
- Command router integration completed
- File type support implemented for YAML and Markdown

### Completion Notes List
- ✅ EditAgent class created with comprehensive edit functionality
- ✅ File reading and parsing implemented for YAML and Markdown files
- ✅ Edit operation processing logic with support for replace, add, remove, and update operations
- ✅ File validation and integrity checks implemented
- ✅ Comprehensive error handling for all edit operations
- ✅ Backup file creation with timestamped naming before edit operations
- ✅ User interface with success/error feedback and progress indicators
- ✅ Command router integration with `/edit` command support
- ✅ Help system with usage examples and instruction formats
- ✅ Complete unit test suite with 14 test cases covering all functionality
- ✅ Support for context files (YAML), outline files (Markdown), and story files (Markdown)
- ✅ Character name editing, plot point editing, and story content editing capabilities

### File List
- `src/agents/editAgent.ts` - New EditAgent implementation
- `src/agents/commandRouter.ts` - Updated with edit command integration
- `src/__tests__/editAgent.test.ts` - New comprehensive test suite

### Change Log
- 2024-12-19: Initial story draft created

## QA Results

### Review Date: 2025-01-21

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment**: Excellent implementation of edit functionality with comprehensive file operations and robust error handling. The code demonstrates advanced TypeScript practices and well-architected design patterns.

**Strengths**:
- Sophisticated file editing with backup and validation
- Excellent error handling with detailed context
- Well-structured file operations with proper validation
- Advanced TypeScript usage with proper interfaces
- Intelligent fallback mechanisms for missing data
- Good separation of concerns with dedicated methods
- Excellent backup and recovery mechanisms
- Comprehensive validation and error recovery

**Areas for Improvement**:
- Could benefit from more integration tests
- Consider adding performance optimization for large files

### Refactoring Performed

**File**: `src/agents/editAgent.ts`
- **Change**: Enhanced error context in file editing operations
- **Why**: Improve debugging capabilities for complex edit operations
- **How**: Added more detailed error context and validation logging

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript standards
- **Project Structure**: ✓ Perfect alignment with architecture requirements
- **Testing Strategy**: ✓ Good test coverage with core functionality tested
- **All ACs Met**: ✓ All acceptance criteria successfully implemented

### Improvements Checklist

- [x] Enhanced error context in file editing operations
- [ ] Add integration tests for complete edit workflow
- [ ] Consider adding performance optimization for large files
- [ ] Add validation for edit operation consistency

### Security Review

**Status**: PASS
- No security vulnerabilities identified
- Safe file operations with proper path validation
- No sensitive data exposure in logs
- Proper input validation prevents injection attacks

### Performance Considerations

**Status**: PASS
- Efficient file operations with fs-extra
- Proper async/await usage throughout
- Good memory management with reasonable object creation
- Fast edit operations with intelligent defaults

### Files Modified During Review

- `src/agents/editAgent.ts` - Enhanced error context in file editing operations

### Gate Status

**Gate**: PASS → docs/qa/gates/1.5-basic-edit-functionality.yml
**Risk profile**: docs/qa/assessments/1.5-risk-20250121.md
**NFR assessment**: docs/qa/assessments/1.5-nfr-20250121.md

### Recommended Status

**✓ Ready for Done** - Excellent implementation with all requirements met
- 2025-01-21: Story implementation completed - all tasks and subtasks marked complete
- 2025-01-21: EditAgent fully implemented with YAML and Markdown support
- 2025-01-21: Command router integration completed with help system
- 2025-01-21: Comprehensive test suite created and all tests passing
