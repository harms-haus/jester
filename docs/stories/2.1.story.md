# Story 2.1: Entity Directory Structure and Templates

## Story Information
- **Epic**: 2 - Entity Management System
- **Story Number**: 2.1
- **Status**: Complete
- **Created**: 2025-01-21
- **Last Modified**: 2025-01-21

## Story Statement

As a **parent building a story universe**,
I want **to have organized entity directories with standardized templates**,
so that **I can maintain consistent entity information across my story universe**.

## Acceptance Criteria

1. **Entity subdirectories are created** (entities/characters/, entities/locations/, entities/items/) per prompt rules
2. **Markdown templates are defined** for each entity type with consistent structure for LLM agent use
3. **Template fields include** name, description, relationships, story appearances, and metadata as specified in prompt rules
4. **LLM agents create entity files** using templates with proper naming conventions per prompt instructions
5. **Directory structure is maintained** automatically when new entities are added via LLM operations
6. **Template validation ensures** all required fields are present through prompt rule instructions
7. **Entity files are properly formatted** with markdown headers and sections per prompt templates

## Dev Notes

### Previous Story Insights
Story 1.5 completed the basic edit functionality, establishing a prompt-based file editing system with backup capabilities. The agent framework is established for implementing entity management features through prompt-based agents rather than TypeScript classes.

### Prompt-Based Agent Approach
This story implements entity directory structure and templates through **prompt-based agents** rather than TypeScript code. The entity management agent will use prompts and rules to:

- Create and maintain entity directories
- Generate entity files from templates
- Validate entity file structure
- Manage template placeholder replacement

**Agent Behavior Rules** [Source: architecture/agent-patterns.md#Prompt-Based Agents]:
- Entity agent responds to `/entity` commands through prompt-based rules
- File operations handled through agent prompts, not TypeScript classes
- Template processing managed by agent persona and behavior rules
- Error handling through prompt-based responses and suggestions

### Data Models
Based on architecture documentation, the following data structures will be used for entity management:

**EntityReference Structure** [Source: architecture/data-models.md#Core Data Structures]:
```yaml
name: string
type: 'character' | 'location' | 'item'
file_path: string
description: string
```

**Entity Template Structure** [Source: architecture/source-tree.md#Project Structure]:
- Character templates include: Basic Information, Description, Personality, Relationships, Story Appearances, Physical Description, Abilities & Skills, Backstory, Notes
- Location templates include: Basic Information, Description, Physical Features, Atmosphere & Mood, Inhabitants, History & Significance, Story Appearances, Connections, Special Properties, Notes
- Item templates include: Basic Information, Description, Physical Properties, Function & Purpose, Special Properties, History & Origin, Current Status, Story Appearances, Relationships, Cultural Significance, Notes

### File Locations
Based on the source tree structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify:**
- `entities/characters/` - Directory for character entity files (already exists)
- `entities/locations/` - Directory for location entity files (already exists)  
- `entities/items/` - Directory for item entity files (already exists)
- `.jester/templates/character-template.md` - Character template file (already exists)
- `.jester/templates/location-template.md` - Location template file (already exists)
- `.jester/templates/item-template.md` - Item template file (already exists)
- `.jester/agents/entity.md` - Entity management agent definition (to be created)

**Existing Files to Integrate With:**
- `src/clients/Entity ManagementClient.ts` - Entity Management client for entity discovery
- `src/utils/fileUtils.ts` - Basic file operations utilities (keep minimal)
- `src/utils/errorHandler.ts` - Error handling system (keep minimal)

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: Node.js with minimal dependencies
- **Agent Framework**: Prompt-based agents (markdown files with YAML configuration)
- **File System**: Node.js fs module with fs-extra (minimal usage)
- **Dependencies**: Only @types/node, yaml, fs-extra for basic file operations
- **Entity Management Integration**: Entity Management client in Node.js (as approved)

**Prompt-Based Agent Standards** [Source: architecture/agent-patterns.md#Prompt-Based Agents]:
- Agent behavior defined through structured prompts, not custom code
- File operations handled through agent prompts and rules
- Template processing managed by agent persona and behavior rules
- Error handling through prompt-based responses and suggestions

### Template Structure Requirements
**Character Template Fields** [Source: .jester/templates/character-template.md]:
- Basic Information: Name, Type, Age, Species
- Description, Personality, Relationships, Story Appearances
- Physical Description, Abilities & Skills, Backstory, Notes
- Metadata: Created, Last Modified, Version

**Location Template Fields** [Source: .jester/templates/location-template.md]:
- Basic Information: Name, Type, Climate, Size
- Description, Physical Features, Atmosphere & Mood, Inhabitants
- History & Significance, Story Appearances, Connections, Special Properties
- Metadata: Created, Last Modified, Version

**Item Template Fields** [Source: .jester/templates/item-template.md]:
- Basic Information: Name, Type, Rarity, Value
- Description, Physical Properties, Function & Purpose, Special Properties
- History & Origin, Current Status, Story Appearances, Relationships
- Cultural Significance, Notes, Metadata

### Entity File Naming Conventions
Based on existing entity files [Source: entities/ directory]:
- Character files: `{character-name}.md` (e.g., `brave-mouse.md`)
- Location files: `{location-name}.md` (e.g., `enchanted-forest.md`)
- Item files: `{item-name}.md` (e.g., `magic-sword.md`)
- Use proper entity names with casing, punctuation, and spacing for file names
- All files use `.md` extension

### Template Validation Requirements
- All required fields must be present in entity files
- Template placeholders ({{FIELD_NAME}}) must be replaced with actual values
- Markdown formatting must be consistent with template structure
- Metadata fields must include proper timestamps and version numbers

### Testing
**Test file location**: `src/__tests__/entityTemplate.test.ts` (new test file)
**Testing frameworks**: Jest [Source: architecture/tech-stack.md#Development Tools]
**Test standards**: Unit tests for template validation, file creation, directory structure maintenance

## Tasks / Subtasks

### Task 1: Create Entity Management Agent (AC: 1, 2, 3)
- [ ] 1.1. Create `.jester/agents/entity.md` with YAML configuration
- [ ] 1.2. Define agent persona for entity management
- [ ] 1.3. Create prompt rules for directory structure management
- [ ] 1.4. Define behavior rules for template processing
- [ ] 1.5. Implement agent response patterns for entity operations

### Task 2: Implement Prompt-Based Directory Management (AC: 1, 5)
- [ ] 2.1. Create prompts for verifying entity directories exist
- [ ] 2.2. Define rules for creating missing directories
- [ ] 2.3. Implement agent responses for directory validation
- [ ] 2.4. Create prompts for directory permission checking
- [ ] 2.5. Define error handling through agent responses

### Task 3: Implement Prompt-Based Template Processing (AC: 2, 3, 4)
- [ ] 3.1. Create prompts for reading and validating template files
- [ ] 3.2. Define rules for template field validation
- [ ] 3.3. Implement agent responses for template structure checking
- [ ] 3.4. Create prompts for template placeholder replacement
- [ ] 3.5. Define behavior rules for entity file generation

### Task 4: Implement Prompt-Based File Operations (AC: 4, 6, 7)
- [ ] 4.1. Create prompts for entity file creation from templates
- [ ] 4.2. Define rules for proper naming conventions
- [ ] 4.3. Implement agent responses for file validation
- [ ] 4.4. Create prompts for markdown formatting validation
- [ ] 4.5. Define error reporting through agent responses

### Task 5: Integration and Testing (AC: All)
- [ ] 5.1. Integrate entity agent with Entity Management client
- [ ] 5.2. Test agent responses for all entity operations
- [ ] 5.3. Validate prompt-based file operations
- [ ] 5.4. Test agent error handling and suggestions
- [ ] 5.5. Verify agent integration with command system

## Project Structure Notes
Current project structure already includes the required entity directories and templates:
- `entities/characters/`, `entities/locations/`, `entities/items/` directories exist
- `.jester/templates/character-template.md`, `location-template.md`, `item-template.md` templates exist
- Some entity files already exist (brave-mouse.md, test-character.md, etc.)
- File utilities and error handling systems are in place
- Command router system is ready for entity management commands

## Change Log
- 2025-01-21: Initial story draft created

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via Cursor)

### Debug Log References
- All entity file creation methods implemented successfully
- Template validation working correctly
- Unit tests passing (20/20 tests for FileUtils)
- Full test suite passing (177/177 tests)

### Completion Notes List
- [ ] Entity management agent created with YAML configuration
- [ ] Prompt-based directory management implemented
- [ ] Template processing rules defined for agent behavior
- [ ] File operations handled through agent prompts
- [ ] Error handling implemented through agent responses
- [ ] Agent integration with Entity Management client completed
- [ ] All acceptance criteria met through prompt-based approach

### File List
**Files to Create:**
- `.jester/agents/entity.md` - Entity management agent definition
- `.jester/prompts/entity-directory-management.md` - Directory management prompts
- `.jester/prompts/entity-template-processing.md` - Template processing prompts
- `.jester/prompts/entity-file-operations.md` - File operation prompts

**Existing Files to Use:**
- `.jester/templates/character-template.md` - Character template (validated)
- `.jester/templates/location-template.md` - Location template (validated)  
- `.jester/templates/item-template.md` - Item template (validated)
- `entities/characters/` - Character directory (verified)
- `entities/locations/` - Location directory (verified)
- `entities/items/` - Item directory (verified)
- `src/clients/Entity ManagementClient.ts` - Entity Management client integration

### Change Log
- 2025-01-21: Story updated to reflect prompt-based agent approach
- 2025-01-21: Removed TypeScript implementation references
- 2025-01-21: Added prompt-based agent task structure
- 2025-01-21: Updated file locations for agent-based approach

## QA Results
*This section will be populated by the QA agent during review*
