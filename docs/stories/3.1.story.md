# Story 3.1: Entity Relationship Discovery

## Story Information
- **Epic**: 3 - LightRAG Integration
- **Story Number**: 3.1
- **Status**: Draft
- **Created**: 2025-01-27
- **Last Modified**: 2025-01-27

## Story Statement

As a **parent building a story universe**,
I want **to discover new entity relationships through LightRAG**,
so that **I can find connections I might have missed in my local files**.

## Acceptance Criteria

1. **LightRAG queries** search for entities similar to local entities
2. **Relationship suggestions** are generated based on LightRAG knowledge graph
3. **Entity connections** are discovered between local and LightRAG entities
4. **Relationship confidence** scores indicate the strength of suggested connections
5. **Relationship filtering** allows filtering by entity type and connection strength
6. **Relationship export** saves discovered connections for local use
7. **Relationship validation** ensures suggested connections make sense

## Tasks / Subtasks

- [ ] Task 1: Implement LightRAG Entity Query System (AC: 1)
  - [ ] 1.1. Create entity similarity query logic using LightRAG `/query` endpoint
  - [ ] 1.2. Implement entity content analysis for query generation
  - [ ] 1.3. Add query optimization to minimize LightRAG API calls
  - [ ] 1.4. Create query result caching mechanism
  - [ ] 1.5. Implement error handling for LightRAG service unavailability

- [ ] Task 2: Implement Relationship Suggestion Engine (AC: 2)
  - [ ] 2.1. Create relationship suggestion algorithm using LightRAG knowledge graph
  - [ ] 2.2. Implement confidence scoring based on LightRAG response scores
  - [ ] 2.3. Add reasoning generation for relationship suggestions
  - [ ] 2.4. Create suggestion ranking and filtering logic
  - [ ] 2.5. Implement suggestion validation against local entity data

- [ ] Task 3: Implement Entity Connection Discovery (AC: 3)
  - [ ] 3.1. Create entity connection mapping between local and LightRAG entities
  - [ ] 3.2. Implement connection strength calculation using LightRAG scores
  - [ ] 3.3. Add entity type matching and validation
  - [ ] 3.4. Create connection visualization logic
  - [ ] 3.5. Implement connection browsing and exploration features

- [ ] Task 4: Implement Relationship Confidence Scoring (AC: 4)
  - [ ] 4.1. Create confidence score calculation based on LightRAG response scores
  - [ ] 4.2. Implement score normalization and ranking
  - [ ] 4.3. Add confidence threshold configuration
  - [ ] 4.4. Create confidence score display and filtering
  - [ ] 4.5. Implement confidence-based suggestion filtering

- [ ] Task 5: Implement Relationship Filtering System (AC: 5)
  - [ ] 5.1. Create entity type filtering (character, location, item)
  - [ ] 5.2. Implement connection strength filtering
  - [ ] 5.3. Add confidence score filtering
  - [ ] 5.4. Create keyword-based relationship filtering
  - [ ] 5.5. Implement combined filter logic and UI

- [ ] Task 6: Implement Relationship Export Functionality (AC: 6)
  - [ ] 6.1. Create relationship export to local entity files
  - [ ] 6.2. Implement wiki-style link creation in entity files
  - [ ] 6.3. Add relationship metadata tracking
  - [ ] 6.4. Create export format options (JSON, Markdown)
  - [ ] 6.5. Implement export validation and error handling

- [ ] Task 7: Implement Relationship Validation System (AC: 7)
  - [ ] 7.1. Create content-based relationship validation
  - [ ] 7.2. Implement user confirmation system for suggestions
  - [ ] 7.3. Add conflict detection for existing relationships
  - [ ] 7.4. Create consistency checking across entity files
  - [ ] 7.5. Implement validation error handling and reporting

## Dev Notes

### Previous Story Insights
From Story 2.5 (Entity Relationship Discovery), the system already has local relationship discovery capabilities. This story builds upon that foundation by integrating LightRAG for enhanced relationship discovery across a broader knowledge base.

### Data Models
[Source: architecture/data-models.md#Core Data Structures]

The system uses the following key data structures:
- `Entity` interface with id, name, type, description, properties, relationships, last_used, usage_count
- `StoryContext` with entities containing EntityReference arrays for characters, locations, and items
- Entity types: 'character' | 'location' | 'item'

### API Specifications
[Source: architecture/api-specification.md#LightRAG OpenAPI Integration]

**Key LightRAG Endpoints:**
- `POST /query` - Natural language queries with reranking support
- `POST /query/data` - Structured data queries for knowledge graph entities and relationships
- `GET /graph/label/list` - Retrieve all node labels (IDs) in the datastore
- `GET /graphs` - Get graph node data
- `GET /graph/entity/exists` - Check entity existence for local file validation

**Request/Response Format:**
- QueryRequest: { query: string, documents?: Array<{content: string, id: string}>, enable_rerank?: boolean }
- QueryResponse: { reranked_documents: Array<{content: string, id: string, score: number}> }
- DataQueryResponse: Contains entities, relationships, and chunks arrays with detailed metadata

**LightRAGClient Interface:**
- query(query: string, enableRerank?: boolean): Promise<QueryResponse>
- queryData(query: string, format?: string, includeVectors?: boolean): Promise<DataQueryResponse>
- getGraphLabels(): Promise<GraphLabelListResponse>
- getGraphNodes(): Promise<GraphNodeDataResponse>
- checkEntityExists(entityId: string, entityType?: string): Promise<EntityExistsResponse>

### Component Specifications
[Source: architecture/api-specification.md#Integration Notes]

**Integration Requirements:**
- MCP client handles all LightRAG communication through HTTP requests
- Responses cached locally to minimize API calls and costs
- Error handling for network failures, authentication issues, and rate limits
- Offline mode when LightRAG service unavailable
- Reranking enabled by default for better relevance
- Support for multiple export formats (JSON, CSV, Excel, Markdown, Text)

### File Locations
[Source: architecture/data-models.md#File System Structure]

**Project Structure:**
- Entity files: `entities/characters/`, `entities/locations/`, `entities/items/`
- Story files: `stories/`
- LightRAG client: `src/clients/lightragClient.ts`
- Services: `src/services/lightragService.ts`
- Types: `src/types/` (for LightRAG interfaces)

### Technical Constraints
[Source: architecture/tech-stack.md#External Services]

**Dependencies:**
- LightRAG: Knowledge graph service for entity relationships
- MCP Client: Python client for LightRAG OpenAPI integration
- External LLM: Any LLM service capable of following prompt rules and performing file operations

**Performance Considerations:**
- Query caching to minimize LightRAG API calls
- Offline mode when LightRAG service unavailable
- Reranking enabled by default for better relevance
- Streaming support for real-time query results

### Testing Requirements
No specific testing strategy found in architecture docs. Following general coding standards:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*
