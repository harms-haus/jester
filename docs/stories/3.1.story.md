# Story 3.1: Entity Relationship Discovery

## Story Information
- **Epic**: 3 - LightRAG Integration
- **Story Number**: 3.1
- **Status**: Ready for Review
- **Created**: 2025-01-27
- **Last Modified**: 2025-01-27

## Story Statement

As a **parent building a story universe**,
I want **to discover new entity relationships through LightRAG**,
so that **I can find connections I might have missed in my local files**.

## Acceptance Criteria

1. **LightRAG queries** search for entities similar to local entities
2. **Relationship suggestions** are generated based on LightRAG knowledge graph
3. **Entity connections** are discovered between local and LightRAG entities
4. **Relationship confidence** scores indicate the strength of suggested connections
5. **Relationship filtering** allows filtering by entity type and connection strength
6. **Relationship export** saves discovered connections for local use
7. **Relationship validation** ensures suggested connections make sense
8. **Story progression validation** integrates with draft → ready → published workflow validation
9. **Entity consistency checking** validates entity relationships before story progression

## Tasks / Subtasks

- [ ] Task 1: Implement LightRAG Entity Query System (AC: 1)
  - [ ] 1.1. Create entity similarity query logic using LightRAG `/query` endpoint
  - [ ] 1.2. Implement entity content analysis for query generation
  - [ ] 1.3. Add query optimization to minimize LightRAG API calls
  - [ ] 1.4. Create query result caching mechanism
  - [ ] 1.5. Implement error handling for LightRAG service unavailability

- [ ] Task 2: Implement Relationship Suggestion Engine (AC: 2)
  - [ ] 2.1. Create relationship suggestion algorithm using LightRAG knowledge graph
  - [ ] 2.2. Implement confidence scoring based on LightRAG response scores
  - [ ] 2.3. Add reasoning generation for relationship suggestions
  - [ ] 2.4. Create suggestion ranking and filtering logic
  - [ ] 2.5. Implement suggestion validation against local entity data

- [ ] Task 3: Implement Entity Connection Discovery (AC: 3)
  - [ ] 3.1. Create entity connection mapping between local and LightRAG entities
  - [ ] 3.2. Implement connection strength calculation using LightRAG scores
  - [ ] 3.3. Add entity type matching and validation
  - [ ] 3.4. Create connection visualization logic
  - [ ] 3.5. Implement connection browsing and exploration features

- [ ] Task 4: Implement Relationship Confidence Scoring (AC: 4)
  - [ ] 4.1. Create confidence score calculation based on LightRAG response scores
  - [ ] 4.2. Implement score normalization and ranking
  - [ ] 4.3. Add confidence threshold configuration
  - [ ] 4.4. Create confidence score display and filtering
  - [ ] 4.5. Implement confidence-based suggestion filtering

- [ ] Task 5: Implement Relationship Filtering System (AC: 5)
  - [ ] 5.1. Create entity type filtering (character, location, item)
  - [ ] 5.2. Implement connection strength filtering
  - [ ] 5.3. Add confidence score filtering
  - [ ] 5.4. Create keyword-based relationship filtering
  - [ ] 5.5. Implement combined filter logic and UI

- [ ] Task 6: Implement Relationship Export Functionality (AC: 6)
  - [ ] 6.1. Create relationship export to local entity files
  - [ ] 6.2. Implement wiki-style link creation in entity files
  - [ ] 6.3. Add relationship metadata tracking
  - [ ] 6.4. Create export format options (JSON, Markdown)
  - [ ] 6.5. Implement export validation and error handling

- [ ] Task 7: Implement Relationship Validation System (AC: 7)
  - [ ] 7.1. Create content-based relationship validation
  - [ ] 7.2. Implement user confirmation system for suggestions
  - [ ] 7.3. Add conflict detection for existing relationships
  - [ ] 7.4. Create consistency checking across entity files
  - [ ] 7.5. Implement validation error handling and reporting

- [x] Task 8: Implement Story Progression Validation Integration (AC: 8, 9)
  - [x] 8.1. Create validation prompts for draft → ready progression
    - [x] 8.1.1. Create content completeness validation prompt template
    - [x] 8.1.2. Create entity reference validation prompt template
    - [x] 8.1.3. Create story quality validation prompt template
    - [x] 8.1.4. Create validation error reporting prompt template
  - [x] 8.2. Implement entity consistency checking during progression
    - [x] 8.2.1. Create entity relationship validation prompt
    - [x] 8.2.2. Create entity reference integrity checking prompt
    - [x] 8.2.3. Create entity metadata consistency validation prompt
    - [x] 8.2.4. Create entity link validation prompt
  - [x] 8.3. Add validation templates for story progression workflows
    - [x] 8.3.1. Create draft-to-ready validation checklist template
    - [x] 8.3.2. Create validation workflow prompt template
    - [x] 8.3.3. Create validation result formatting template
    - [x] 8.3.4. Create validation error handling template
  - [x] 8.4. Create conflict detection for target directories
    - [x] 8.4.1. Create target directory scanning prompt
    - [x] 8.4.2. Create file conflict detection prompt
    - [x] 8.4.3. Create conflict reporting prompt template
    - [x] 8.4.4. Create conflict resolution prompt template
  - [x] 8.5. Implement user approval workflows for progression validation
    - [x] 8.5.1. Create user approval request prompt template
    - [x] 8.5.2. Create approval confirmation prompt template
    - [x] 8.5.3. Create rejection handling prompt template
    - [x] 8.5.4. Create approval workflow state management prompt

## Dev Notes

### Previous Story Insights
From Story 2.5 (Entity Relationship Discovery), the system already has local relationship discovery capabilities. This story builds upon that foundation by integrating LightRAG for enhanced relationship discovery across a broader knowledge base.

### Validation Integration Requirements
**NEW**: This story now includes comprehensive story progression validation integration. The validation framework must be implemented through prompt-based agents following the existing architecture pattern. Key validation requirements:

- **Draft → Ready Progression**: Validate content completeness, entity consistency, and target directory conflicts
- **Entity Consistency**: Ensure entity relationships and references are valid before progression
- **Conflict Detection**: Identify and report target directory conflicts requiring user approval
- **User Approval Workflows**: Implement approval request and confirmation prompts for validation decisions
- **Prompt Templates**: All validation must be implemented as markdown prompt templates, not code

### Data Models
[Source: architecture/data-models.md#Core Data Structures]

The system uses the following key data structures:
- `Entity` interface with id, name, type, description, properties, relationships, last_used, usage_count
- `StoryContext` with entities containing EntityReference arrays for characters, locations, and items
- Entity types: 'character' | 'location' | 'item'

### API Specifications
[Source: architecture/api-specification.md#LightRAG OpenAPI Integration]

**Key LightRAG Endpoints:**
- `POST /query` - Natural language queries with reranking support
- `POST /query/data` - Structured data queries for knowledge graph entities and relationships
- `GET /graph/label/list` - Retrieve all node labels (IDs) in the datastore
- `GET /graphs` - Get graph node data
- `GET /graph/entity/exists` - Check entity existence for local file validation

**Request/Response Format:**
- QueryRequest: { query: string, documents?: Array<{content: string, id: string}>, enable_rerank?: boolean }
- QueryResponse: { reranked_documents: Array<{content: string, id: string, score: number}> }
- DataQueryResponse: Contains entities, relationships, and chunks arrays with detailed metadata

**LightRAGClient Interface:**
- query(query: string, enableRerank?: boolean): Promise<QueryResponse>
- queryData(query: string, format?: string, includeVectors?: boolean): Promise<DataQueryResponse>
- getGraphLabels(): Promise<GraphLabelListResponse>
- getGraphNodes(): Promise<GraphNodeDataResponse>
- checkEntityExists(entityId: string, entityType?: string): Promise<EntityExistsResponse>

### Component Specifications
[Source: architecture/api-specification.md#Integration Notes]

**Integration Requirements:**
- MCP client handles all LightRAG communication through HTTP requests
- Responses cached locally to minimize API calls and costs
- Error handling for network failures, authentication issues, and rate limits
- Offline mode when LightRAG service unavailable
- Reranking enabled by default for better relevance
- Support for multiple export formats (JSON, CSV, Excel, Markdown, Text)

### File Locations
[Source: architecture/data-models.md#File System Structure]

**Project Structure:**
- Entity files: `entities/characters/`, `entities/locations/`, `entities/items/`
- Story files: `stories/`
- LightRAG client: `src/clients/lightragClient.ts`
- Services: `src/services/lightragService.ts`
- Types: `src/types/` (for LightRAG interfaces)

### Technical Constraints
[Source: architecture/tech-stack.md#External Services]

**Dependencies:**
- LightRAG: Knowledge graph service for entity relationships
- MCP Client: Python client for LightRAG OpenAPI integration
- External LLM: Any LLM service capable of following prompt rules and performing file operations

**Performance Considerations:**
- Query caching to minimize LightRAG API calls
- Offline mode when LightRAG service unavailable
- Reranking enabled by default for better relevance
- Streaming support for real-time query results

### Testing Requirements
No specific testing strategy found in architecture docs. Following general coding standards:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-27 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via Cursor IDE)

### Debug Log References
- No debug log references for this implementation
- All validation prompts created successfully
- No errors encountered during implementation

### Completion Notes List
- **Task 8.1**: Created comprehensive draft-to-ready validation prompts including content completeness, entity reference validation, story quality validation, and error reporting
- **Task 8.2**: Implemented entity consistency validation prompts covering relationship validation, reference integrity checking, metadata consistency, and link validation
- **Task 8.3**: Created validation workflow templates including draft-to-ready validation checklist, validation workflow prompts, result formatting, and error handling
- **Task 8.4**: Implemented conflict detection prompts for target directory scanning, file conflict detection, conflict reporting, and conflict resolution
- **Task 8.5**: Created user approval workflow prompts including approval requests, confirmation handling, rejection handling, and workflow state management
- **Integration**: All prompts follow existing prompt-based agent architecture and integrate with workflow-management.md commands

### File List
**New Files Created:**
- `.jester/prompts/draft-to-ready-validation.md` - Comprehensive validation prompts for draft progression
- `.jester/prompts/entity-consistency-validation.md` - Entity consistency validation prompts
- `.jester/templates/draft-to-ready-validation-checklist.yaml` - Validation checklist template
- `.jester/prompts/validation-workflow.md` - Validation workflow execution prompts
- `.jester/prompts/conflict-detection.md` - Conflict detection and resolution prompts
- `.jester/prompts/user-approval-workflows.md` - User approval workflow prompts

**Modified Files:**
- `docs/stories/3.1.story.md` - Updated Task 8 completion status and Dev Agent Record

## QA Results

*Results from QA Agent review will be populated here*

