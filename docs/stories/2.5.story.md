# Story 2.5: Entity Relationship Discovery

## Story Information
- **Epic**: 2 - Entity Management System
- **Story Number**: 2.5
- **Status**: Draft
- **Created**: 2025-01-27
- **Last Modified**: 2025-01-27

## Story Statement

As a **parent building a story universe**,
I want **to discover new relationships between entities**,
so that **I can create more complex and interconnected stories**.

## Acceptance Criteria

1. **Relationship suggestions** are provided based on entity content and context
2. **Entity connection mapping** shows potential relationships between entities
3. **Relationship validation** ensures suggested connections make sense
4. **Relationship creation** automatically updates both entity files
5. **Relationship browsing** allows exploration of entity connections
6. **Relationship statistics** show entity usage and connection patterns
7. **Relationship export** provides data for external analysis

## Dev Notes

### Previous Story Insights
Story 2.4 established the draft/ready/complete workflow system with entity management. The foundation includes:
- Entity management with CRUD operations
- Draft workflow support for maintaining consistency
- File history tracking and version control
- Agent prompt updates for workflow management

### Data Models
Based on the established entity system [Source: architecture/data-models.md#Core Data Structures]:

**Entity Structure**:
```typescript
interface Entity {
  id: string;
  name: string;
  type: 'character' | 'location' | 'item';
  description: string;
  properties: Record<string, any>;
  relationships: string[];
  last_used: string;
  usage_count: number;
}
```

**Relationship Discovery Data**:
```typescript
interface RelationshipSuggestion {
  source_entity: string;
  target_entity: string;
  relationship_type: string;
  confidence_score: number;
  reasoning: string;
  suggested_properties: Record<string, any>;
}

interface EntityConnection {
  entity_id: string;
  connected_entities: Array<{
    entity_id: string;
    relationship_type: string;
    strength: number;
  }>;
  usage_stats: {
    total_connections: number;
    story_appearances: number;
    last_used: string;
  };
}
```

### API Specifications
**LightRAG Integration** [Source: architecture/api-specification.md#LightRAG OpenAPI Integration]:
- **Base URL**: `http://localhost:9621` (configurable)
- **Authentication**: X-API-Key header
- **Key Endpoints**:
  - `POST /query/data` - Structured data queries for knowledge graph entities and relationships
  - `GET /graph/label/list` - Retrieve all node labels (IDs) in the datastore
  - `GET /graphs` - Get graph node data
  - `GET /graph/entity/exists` - Check entity existence

**Data Query Response Structure**:
```typescript
interface DataQueryResponse {
  entities: Array<{
    entity_name: string;
    entity_type: 'person' | 'location' | 'item' | 'technology' | string;
    description: string;
    source_id: string;
    file_path: string;
  }>;
  relationships: Array<{
    src_id: string;
    tgt_id: string;
    description: string;
    keywords: string;
    weight: number;
    source_id: string;
    file_path: string;
  }>;
  chunks: Array<{
    content: string;
    source_id: string;
    file_path: string;
  }>;
}
```

### Component Specifications
**Agent System** [Source: architecture/components.md#Core Components]:
- **Muse Agent**: Entity discovery and relationship queries through LightRAG
- **Edit Agent**: Relationship creation and entity file updates
- **File System Operations**: LLM agents perform file operations as instructed by prompt rules

**LightRAG MCP Client** [Source: architecture/components.md#LightRAG MCP Client]:
- Entity discovery and relationship queries
- Structured data retrieval for story context
- Graph management and entity validation
- Local caching and offline mode support

### File Locations
Based on the project structure [Source: architecture/source-tree.md#Project Structure]:

**Required Files to Create/Modify**:
- `.jester/agents/muse.md` - Add relationship discovery commands
- `.jester/agents/edit.md` - Add relationship creation commands
- `.jester/prompts/relationship-discovery.md` - New relationship discovery prompts
- `src/clients/lightragClient.ts` - Extend with relationship discovery methods
- `src/utils/relationshipUtils.ts` - New relationship utility functions

**Existing Files to Use**:
- `complete/characters/` - Character entity files
- `complete/locations/` - Location entity files
- `complete/items/` - Item entity files
- `src/clients/lightragClient.ts` - LightRAG MCP client integration
- `src/utils/fileUtils.ts` - Basic file operations utilities

### Testing Requirements
**Test file locations**: 
- `src/__tests__/relationshipDiscovery.test.ts` (new test file)

**Testing frameworks**: Jest [Source: architecture/tech-stack.md#Development Tools]

**Test standards**: 
- Unit tests for relationship suggestion algorithms
- Integration tests for LightRAG relationship queries
- Validation tests for relationship creation
- Error handling tests for relationship operations

### Technical Constraints
**Tech Stack Requirements** [Source: architecture/tech-stack.md#Core Technologies]:
- **Runtime**: External LLM agents following prompt rules
- **Prompt Framework**: Markdown files with YAML configuration (BMAD pattern)
- **File System**: LLM agents performing file operations per prompt instructions
- **MCP Client**: Python MCP client for LightRAG API integration

**Coding Standards** [Source: architecture/coding-standards.md#TypeScript Standards]:
- Use strict TypeScript configuration
- Prefer interfaces over types for object shapes
- Use explicit return types for public methods
- Follow camelCase for variables and functions
- Use PascalCase for classes and interfaces

**Error Handling** [Source: architecture/coding-standards.md#Error Handling]:
- Use try-catch blocks for async operations
- Provide meaningful error messages
- Log errors with context information
- Graceful degradation for non-critical failures

### Relationship Discovery Features to Implement
**Relationship Suggestion Algorithm**:
- Analyze entity descriptions for common themes, locations, or characteristics
- Use LightRAG knowledge graph to find semantic connections
- Calculate confidence scores based on content similarity
- Provide reasoning for suggested relationships

**Entity Connection Mapping**:
- Visual representation of entity relationships
- Strength-based connection weighting
- Interactive exploration of entity networks
- Filtering by relationship type or strength

**Relationship Validation**:
- Content-based validation of suggested relationships
- User confirmation for relationship creation
- Conflict detection for existing relationships
- Consistency checking across entity files

**Relationship Creation**:
- Automatic updates to both entity files
- Wiki-style link creation between entities
- Relationship metadata tracking
- Version control integration

**Relationship Browsing**:
- List all relationships for a specific entity
- Search relationships by type or keywords
- Navigate between connected entities
- Export relationship data for analysis

**Relationship Statistics**:
- Entity usage tracking and patterns
- Connection strength analysis
- Relationship evolution over time
- Growth pattern identification

## Tasks / Subtasks

### Task 1: Implement Relationship Suggestion Algorithm (AC: 1)
- [ ] 1.1. Create entity content analysis logic
- [ ] 1.2. Implement LightRAG query integration for relationship discovery
- [ ] 1.3. Create confidence scoring algorithm
- [ ] 1.4. Add reasoning generation for suggestions
- [ ] 1.5. Create suggestion validation logic

### Task 2: Implement Entity Connection Mapping (AC: 2)
- [ ] 2.1. Create entity relationship data structure
- [ ] 2.2. Implement connection strength calculation
- [ ] 2.3. Create visual representation logic
- [ ] 2.4. Add interactive exploration features
- [ ] 2.5. Implement filtering and search capabilities

### Task 3: Implement Relationship Validation (AC: 3)
- [ ] 3.1. Create content-based validation logic
- [ ] 3.2. Implement user confirmation system
- [ ] 3.3. Add conflict detection for existing relationships
- [ ] 3.4. Create consistency checking across entity files
- [ ] 3.5. Implement validation error handling

### Task 4: Implement Relationship Creation (AC: 4)
- [ ] 4.1. Create automatic entity file update logic
- [ ] 4.2. Implement wiki-style link creation
- [ ] 4.3. Add relationship metadata tracking
- [ ] 4.4. Integrate with version control system
- [ ] 4.5. Create relationship creation error handling

### Task 5: Implement Relationship Browsing (AC: 5)
- [ ] 5.1. Create entity relationship listing functionality
- [ ] 5.2. Implement relationship search by type/keywords
- [ ] 5.3. Add navigation between connected entities
- [ ] 5.4. Create relationship browsing interface
- [ ] 5.5. Implement browsing performance optimization

### Task 6: Implement Relationship Statistics (AC: 6)
- [ ] 6.1. Create entity usage tracking system
- [ ] 6.2. Implement connection strength analysis
- [ ] 6.3. Add relationship evolution tracking
- [ ] 6.4. Create growth pattern identification
- [ ] 6.5. Implement statistics visualization

### Task 7: Implement Relationship Export (AC: 7)
- [ ] 7.1. Create relationship data export functionality
- [ ] 7.2. Implement multiple export formats (JSON, CSV, Excel)
- [ ] 7.3. Add export filtering and selection options
- [ ] 7.4. Create export validation and error handling
- [ ] 7.5. Implement export performance optimization

### Task 8: Update Agent Prompts and Documentation (AC: All)
- [ ] 8.1. Update .jester/agents/muse.md with relationship discovery commands
- [ ] 8.2. Update .jester/agents/edit.md with relationship creation commands
- [ ] 8.3. Create .jester/prompts/relationship-discovery.md
- [ ] 8.4. Update documentation with relationship discovery features
- [ ] 8.5. Create relationship discovery usage examples

### Task 9: Integration and Testing (AC: All)
- [ ] 9.1. Test relationship suggestion algorithm
- [ ] 9.2. Test entity connection mapping
- [ ] 9.3. Test relationship validation and creation
- [ ] 9.4. Test relationship browsing and statistics
- [ ] 9.5. Test relationship export functionality

## Project Structure Notes
The relationship discovery system builds on the existing entity management:
- Uses established entity structure from complete/ directory
- Integrates with LightRAG MCP client for knowledge graph queries
- Extends existing agent prompts with relationship discovery commands
- Maintains consistency with existing file naming and structure conventions

## Change Log
- 2025-01-27: Story created to implement entity relationship discovery system
- 2025-01-27: Added comprehensive relationship discovery requirements and task structure
- 2025-01-27: Integrated with existing entity management and LightRAG MCP client

## Dev Agent Record
*This section will be populated by the Dev agent during implementation*

## QA Results
*This section will be populated by the QA agent during review*
