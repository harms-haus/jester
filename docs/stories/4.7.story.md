# Story 4.7: Target Audience Management System

## Story Information
- **Epic**: 4 - Advanced Story Generation
- **Story Number**: 4.7
- **Status**: Ready for Development
- **Created**: 2024-12-19
- **Last Modified**: 2024-12-19

## Story Statement

As a **parent creating bedtime stories for my children**,
I want **to create and manage target audience member profiles with automatic age calculation and intelligent parameter adjustment**,
so that **my stories are perfectly tailored to my children's ages and preferences**.

## Acceptance Criteria

1. **Target audience member creation** via `/jester audience create [name] [birthday]` command
2. **Target audience member editing** via `/jester audience edit [name]` command for updating preferences
3. **Target audience member listing** via `/jester audience list` command shows all created members
4. **Target audience member selection** via `/jester audience select [name1] [name2]` command for story generation
5. **Automatic age calculation** from birthday information with current date
6. **Intelligent parameter adjustment** when multiple members selected:
   - Age range calculation with appropriate wiggle room (e.g., 3-5 becomes 2-6)
   - Target word count using overlap range algorithm with minimum 200-word range
7. **Target audience profile persistence** in `.memory/target-audience-profiles.yaml`
8. **Template-based initialization** creates `.memory/target-audience-profiles.yaml` from `.jester/templates/memory/target-audience-profiles-template.yaml` if it doesn't exist
9. **Integration with context generation** via `/muse create-new` command uses selected target audience
10. **Integration with story generation** via `/write` commands respects target audience parameters
11. **Target audience parameter display** shows calculated ranges and word counts before story generation
12. **Target audience validation** ensures selected members exist and have valid data
13. **Target audience fallback** uses default parameters if no members selected or profiles unavailable

## Tasks / Subtasks

- [ ] Task 1: Implement Target Audience Profile Management (AC: 1, 2, 3, 7, 8)
  - [ ] 1.1. Create target audience profile creation command and prompts
  - [ ] 1.2. Implement profile editing functionality with validation
  - [ ] 1.3. Add profile listing and display functionality
  - [ ] 1.4. Implement template-based initialization system
  - [ ] 1.5. Add profile persistence and loading mechanisms

- [ ] Task 2: Implement Parameter Calculation Engine (AC: 5, 6)
  - [ ] 2.1. Create age calculation logic from birthday information
  - [ ] 2.2. Implement overlap range algorithm for word count calculation
  - [ ] 2.3. Add intelligent parameter adjustment for multiple members
  - [ ] 2.4. Implement boundary validation and adjustment logic
  - [ ] 2.5. Add calculation method tracking and audit trails

- [ ] Task 3: Implement Target Audience Selection System (AC: 4, 11, 12, 13)
  - [ ] 3.1. Create target audience member selection commands
  - [ ] 3.2. Implement active member tracking and persistence
  - [ ] 3.3. Add parameter display and confirmation prompts
  - [ ] 3.4. Implement validation and error handling
  - [ ] 3.5. Add fallback mechanisms for missing profiles

- [ ] Task 4: Integrate with Story Generation Pipeline (AC: 9, 10)
  - [ ] 4.1. Update context generation to use target audience parameters
  - [ ] 4.2. Enhance context template with target audience placeholders
  - [ ] 4.3. Update story generation to respect target audience parameters
  - [ ] 4.4. Add target audience parameter propagation through pipeline
  - [ ] 4.5. Implement parameter source tracking and metadata

## Dev Notes

### Previous Story Insights
Stories 1.1-1.6 established the basic project structure, agent framework, and story generation pipeline. Stories 2.1-2.5 implemented the entity management system with wiki-style linking. Stories 3.1-3.3 added LightRAG integration and prompt rules reorganization. This story builds on the existing story generation pipeline to add personalized target audience management.

### Target Audience Management Requirements
This story implements the sophisticated target audience management system designed in the course correction:
- **Profile Management**: Create, edit, list, and select target audience members
- **Age Calculation**: Automatic age calculation from birthday information
- **Parameter Calculation**: Intelligent overlap range algorithm for word counts
- **Integration**: Seamless integration with existing story generation pipeline
- **Persistence**: Template-based initialization and profile persistence

### Data Models
Based on architecture documentation, implementing these interfaces:
```typescript
interface TargetAudienceMember {
  id: string;
  name: string;
  birthday: string; // ISO date format (YYYY-MM-DD)
  preferred_length: {
    min_words: number;
    max_words: number;
    target_words: number;
  };
  preferences: {
    themes: string[];
    characters: string[];
    settings: string[];
  };
  metadata: {
    created_at: string;
    last_modified: string;
    version: number;
  };
}

interface TargetAudienceProfile {
  members: TargetAudienceMember[];
  active_members: string[]; // Array of member IDs
  calculated_parameters: {
    age_range: {
      min_age: number;
      max_age: number;
      expanded_range: {
        min_age: number;
        max_age: number;
      };
    };
    target_length: {
      min_words: number;
      max_words: number;
      target_words: number;
      calculation_method: 'overlap_range' | 'average_centers' | 'single_member';
      overlap_range?: {
        min_words: number;
        max_words: number;
      };
      outer_range: {
        min_words: number;
        max_words: number;
      };
      adjustments?: {
        applied: boolean;
        reason: string;
        original_range: {
          min_words: number;
          max_words: number;
        };
      };
    };
  };
  metadata: {
    last_calculated: string;
    version: number;
  };
}
```

### Word Count Calculation Algorithm
Implementing the sophisticated overlap range algorithm:
1. **Find overlap range** between all member preferences
2. **If overlap exists**: Calculate centered range with minimum 200 words, validate against outer range
3. **If no overlap**: Average the target ranges' centers with minimum 200-word range
4. **Boundary adjustment**: Redistribute excess when boundaries are exceeded
5. **Audit trail**: Track calculation method and any adjustments made

### File Locations
**New Files**:
- `.jester/agents/audience.md` - Target audience management agent
- `.jester/prompts/domains/audience-management/` - Audience management prompts (5+ files)
- `.jester/templates/memory/target-audience-profiles-template.yaml` - Profile template (already created)

**Modified Files**:
- `.jester/agents/jester.md` - Add audience management commands
- `.jester/templates/context-template.yaml` - Add target audience placeholders
- `.jester/prompts/domains/publishing/context-generation.md` - Add target audience integration
- `.jester/prompts/domains/publishing/story-generation.md` - Add target audience awareness

### Technical Constraints
**Dependencies**: 
- Existing story generation pipeline
- Memory system templates (already created)
- YAML configuration system
- Prompt-based agent framework

**Performance Considerations**:
- Age calculation caching to avoid repeated date math
- Parameter calculation caching until member selection changes
- Efficient profile loading and persistence
- Minimal impact on existing story generation performance

**Architectural Patterns**:
- Maintain existing Agent-Based Architecture
- Preserve File-Based Pipeline pattern
- Keep Local-First Storage approach
- Extend Memory System Integration

### Testing Requirements
Following general coding standards:
- Test profile creation, editing, and deletion
- Validate age calculation accuracy
- Test parameter calculation algorithms with various scenarios
- Verify integration with story generation pipeline
- Test template-based initialization
- Validate error handling and fallback mechanisms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation from course correction | Product Owner |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (via Cursor IDE)

### Debug Log References
- No debug log references yet

### Completion Notes List
- Story created based on course correction work and architectural specifications
- Ready for development implementation

### File List
**Files to be created/modified during implementation:**
- `.jester/agents/audience.md` - Target audience management agent
- `.jester/prompts/domains/audience-management/` - Audience management prompts
- `.jester/templates/context-template.yaml` - Enhanced with target audience placeholders
- `.jester/prompts/domains/publishing/context-generation.md` - Target audience integration
- `.jester/prompts/domains/publishing/story-generation.md` - Target audience awareness
- `.jester/agents/jester.md` - Add audience management commands

## QA Results

*Results from QA Agent review will be populated here*
